<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>web_ui – Chat (Standalone)</title>

  <!-- CRITICAL: Apply theme và kích thước TRƯỚC khi CSS render -->
  <!-- Script này PHẢI chạy trước <style> tag để set CSS variables ngay -->
  <script>
    // IIFE chạy ngay khi parse, TRƯỚC khi CSS được apply
    (function() {
      'use strict';
      const root = document.documentElement;
      
      try {
        // 1. Apply theme trước
        const THEME_KEY = "ui_theme";
        const saved = localStorage.getItem(THEME_KEY);
        const systemDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme = saved === "dark" || saved === "light" ? saved : (systemDark ? "dark" : "light");
        root.setAttribute("data-theme", theme);
        
        // 2. Apply topbar height từ ideal (rem) - QUAN TRỌNG: phải set TRƯỚC khi CSS parse
        const TOPBAR_IDEAL_KEY = "ui_topbar_ideal_rem";
        const TOPBAR_MIN_PX = 20;
        const TOPBAR_MAX_PX = 56;
        const TOPBAR_DEFAULT_REM = 2.0;
        
        // Helper để đọc số từ localStorage
        function readNumberLS(key, fallback) {
          const raw = localStorage.getItem(key);
          const n = raw == null ? NaN : parseFloat(raw);
          return Number.isFinite(n) ? n : fallback;
        }
        
        // Lấy ideal rem từ localStorage, fallback về default
        const topbarIdealRem = readNumberLS(TOPBAR_IDEAL_KEY, TOPBAR_DEFAULT_REM);
        
        // Tính remPx từ font-size (mặc định 16px nếu chưa có)
        // Dùng cách an toàn: thử getComputedStyle, nếu không có thì dùng 16
        let remPx = 16;
        try {
          const fs = getComputedStyle(root).fontSize;
          const parsed = parseFloat(fs);
          if (Number.isFinite(parsed) && parsed > 0) {
            remPx = parsed;
          }
        } catch(e) {
          // Fallback về 16 nếu chưa có computed style
        }
        
        const idealPx = topbarIdealRem * remPx;
        const clamped = Math.max(TOPBAR_MIN_PX, Math.min(TOPBAR_MAX_PX, idealPx));
        const pillH = Math.max(16, Math.min(34, Math.round(clamped * 0.64)));
        // Set inline style - có priority cao nhất
        root.style.setProperty("--topbar-h", clamped + "px");
        root.style.setProperty("--topbar-pill-h", pillH + "px");
        
        // 3. Apply chat width từ ideal (vw) - QUAN TRỌNG: phải set TRƯỚC khi CSS parse
        const CHAT_IDEAL_KEY = "ui_chat_ideal_vw";
        const CHAT_MIN_PX = 280;
        const CHAT_MAX_PX = 560;
        const CHAT_DEFAULT_VW = 28;
        
        // Lấy ideal vw từ localStorage, fallback về default
        const chatIdealVw = readNumberLS(CHAT_IDEAL_KEY, CHAT_DEFAULT_VW);
        
        // Tính vwPx từ viewport width (an toàn với window.innerWidth)
        const vwPx = (typeof window !== 'undefined' && window.innerWidth) ? window.innerWidth / 100 : 3.8;
        const chatIdealPx = chatIdealVw * vwPx;
        const chatClamped = Math.max(CHAT_MIN_PX, Math.min(CHAT_MAX_PX, chatIdealPx));
        // Set inline style - có priority cao nhất
        root.style.setProperty("--chat-w", chatClamped + "px");
      } catch(e) {
        // Fallback nếu localStorage bị block
        console.warn("Error applying saved UI settings:", e);
      }
    })();
  </script>

  <!-- CSS chính - script trên đã set inline style cho CSS variables -->
  <style>
    :root{
      /* Warm paper base */
      --bg: #f5f1ea;         /* nền chính: giấy ấm */
      --bg-soft: #f7f3ed;    /* pane trái */
      --pane: #f1ece4;

      /* Panels */
      --panel: #fbf8f3;      /* panel chat: sáng nhưng không trắng gắt */
      --panel-soft: #fdfaf6;
      --panel-stone: #f3eee6;

      /* Text */
      --text: #1c1a17;       /* charcoal ấm */
      --muted: #6c625a;      /* xám ấm */
      --placeholder: #8a8077;

      /* ===== Bubbles (LIGHT) ===== */
      /* User: warm latte (rõ hơn nền/panel) */
      --userBubble: #efe1cf;
      --userBubbleBorder: rgba(28,26,23,0.14);
      --userText: #1c1a17;

      /* AI: text block (document-like, không bubble) */
      --aiText: rgba(28,26,23,0.92);
      
      /* Borders: rất nhẹ, tinh tế */
      --border: rgba(28,26,23,0.10);
      --border-soft: rgba(28,26,23,0.16);

      /* Accent: beige-gold nhẹ */
      --accent: #b79f7a;

      /* Shadow: mềm, không nặng */
      --shadow-soft:
        0 1px 2px rgba(28,26,23,0.05),
        0 10px 26px rgba(28,26,23,0.08);

      --msg-top-inset: 5px;

      /* ===== Topbar sizing (SSOT) ===== */
      --topbar-h: 28px;     /* chỉnh chiều cao topbar ở đây */
      --topbar-pad-x: 10px; /* padding ngang cho nút/clock */
      --topbar-pill-h: 18px;/* chiều cao "pill" (clock/toggle) bên trong */

      /* ===== Chat sizing (SSOT) ===== */
      --chat-w: 380px;          /* width mặc định của panel chat */
      --chat-min-w: 280px;
      --chat-max-w: 560px;      /* tuỳ bạn muốn */

      /* =========================
         TOPBAR + CLOCK — LIGHT
         ========================= */

      /* Topbar: warm paper */
      --topbar-a: #fbf6ee;          /* giấy sáng */
      --topbar-b: #f0e6d6;          /* giấy đậm nhẹ */
      --topbar-fg: #1c1a17;         /* chữ charcoal ấm */
      --topbar-border: rgba(28,26,23,0.12);
      --topbar-glass: rgba(255,255,255,0.65);

      /* Clock: champagne */
      --clock-fg: #1c1a17;          /* chữ giờ */
      --clock-icon: #d4b77c;       /* champagne gold */
      --clock-border: rgba(212,183,124,0.45);
      --clock-glass: rgba(212,183,124,0.18);

      /* Model selector accent (champagne gold) */
      --model-accent: rgba(212,183,124,0.22);
      --model-accent-border: rgba(212,183,124,0.35);
      --model-accent-ring: rgba(212,183,124,0.20);
      --model-accent-hover: rgba(212,183,124,0.12);
      /* Model selector - Light mode colors */
      --model-bg: #f0e6d6; /* Nền giấy ấm */
      --model-bg-hover: #e8dcc8; /* Hover đậm hơn một chút */
      /* Text colors - Light mode */
      --model-fg-main: #1C1A17; /* Warm charcoal - đủ tương phản nhưng không đen gắt */
      --model-fg-muted: rgba(28, 26, 23, 0.55); /* Chữ phụ - nhẹ, không gây nhiễu */
      /* Tick và gạch chân - Light mode */
      --model-tick: #B79F7A; /* Champagne/beige-gold nhạt - ấm, sang, nổi vừa đủ */
      --model-underline: rgba(183, 159, 122, 0.60); /* Cùng hue với tick nhưng mờ hơn */
      /* Border - Light mode */
      --model-border-subtle: rgba(28, 26, 23, 0.10); /* Viền nhẹ nếu cần */

      /* ===== Scrollbar (LIGHT) ===== */
      --sb-track: rgba(28,26,23,0.06);
      --sb-thumb: rgba(28,26,23,0.22);
      --sb-thumb-hover: rgba(28,26,23,0.32);
    }

    :root[data-theme="dark"]{
      /* Warm charcoal base */
      --bg: #0f0e0d;         /* nền tổng thể: than ấm */
      --bg-soft: #141210;    /* pane trái: ấm, không xanh */
      --pane: #171412;

      /* Panels */
      --panel: #141210;      /* chat panel */
      --panel-soft: #171412;
      --panel-stone: #1c1916;

      /* Text */
      --text: #ece6dd;       /* trắng ngà */
      --muted: #b9b0a6;      /* xám ấm */
      --placeholder: #8f877f;

      /* ===== Bubbles (DARK) ===== */
      /* User: warm cocoa (nổi trên panel tối) */
      --userBubble: #241f1a;
      --userBubbleBorder: rgba(236,230,221,0.14);
      --userText: #f1ebe3;

      /* AI: text block (document-like, không bubble) */
      --aiText: rgba(236,230,221,0.92);

      /* Borders */
      --border: rgba(236,230,221,0.10);
      --border-soft: rgba(236,230,221,0.16);

      /* Accent (ấm, nhẹ) */
      --accent: #c9b79c;     /* beige-gold rất nhẹ */

      /* Shadow: mềm, ít tương phản */
      --shadow-soft:
        0 1px 2px rgba(0,0,0,0.35),
        0 10px 28px rgba(0,0,0,0.45);

      /* =========================
         TOPBAR + CLOCK — DARK
         ========================= */

      /* Topbar: warm charcoal */
      --topbar-a: #0e0d0c;
      --topbar-b: #161311;
      --topbar-fg: #ece6dd;        /* ivory */
      --topbar-border: rgba(255,255,255,0.14);
      --topbar-glass: rgba(255,255,255,0.08);

      /* Clock: ĐEN HẲN - chuẩn editor cao cấp */
      --clock-bg: #141210;         /* Đen ấm, cùng họ với panel/chat */
      --clock-border: rgba(255,255,255,0.12); /* Viền */
      --clock-fg: #ECE6DD;         /* Chữ giờ */
      --clock-icon: rgba(236,230,221,0.75); /* Icon/kim đồng hồ */
      --clock-accent: #9FB7A6;      /* Accent rất nhẹ (nếu cần) */
      /* Legacy variables - giữ để tương thích */
      --clock-glass: rgba(159,183,166,0.14);

      /* Model selector accent (sage) */
      --model-accent: rgba(159,183,166,0.18);
      --model-accent-border: rgba(159,183,166,0.32);
      --model-accent-ring: rgba(159,183,166,0.24);
      --model-accent-hover: rgba(159,183,166,0.10);
      /* Model selector - VS Code / Linear / Cursor style */
      --model-fg-main: #ECE6DD; /* Text chính: off-white ấm */
      --model-fg-muted: rgba(236,230,221,0.65); /* Text phụ */
      --model-border-subtle: rgba(255,255,255,0.12); /* Viền */
      --model-hover: rgba(255,255,255,0.08); /* Hover */
      --model-active: rgba(255,255,255,0.12); /* Active */
      --model-accent: #9FB7A6; /* Accent: sage khói */
      /* Background: đen sâu premium */
      --model-bg: #0a0a0a; /* Đen sâu */
      --model-bg-hover: #0d0d0d; /* Hover sáng hơn một chút */
      /* Tick color */
      --model-tick: #ECE6DD;

      /* ===== Scrollbar (DARK) ===== */
      --sb-track: rgba(236,230,221,0.06);
      --sb-thumb: rgba(236,230,221,0.22);
      --sb-thumb-hover: rgba(236,230,221,0.32);
    }

    *{ box-sizing:border-box; }

    html, body, #root{
      height:100% !important;
      width:100% !important;
      margin:0 !important;
      padding:0 !important;
      overflow: hidden !important;
    }

    html {
      overflow: hidden !important;
    }

    body{
      background:var(--bg) !important;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      overflow:hidden !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0 !important;
      padding: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }
    
    /* Đảm bảo #root hiển thị và fill viewport */
    #root {
      height: 100vh !important;
      width: 100vw !important;
      display: block !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      position: relative !important;
    }
    
    /* Đảm bảo UI elements hiển thị (backup rule) */
    .app[data-react="true"] { 
      display: flex !important; 
    }
    .topbar[data-react="true"] { 
      display: grid !important; 
    }
    .chat[data-react="true"] {
      display: flex !important;
    }

    /* ===== Topbar layout: clean (no system log) ===== */
    .topbar{
      position:relative;
      height: var(--topbar-h, 28px) !important; /* Fallback để tránh layout shift */
      width: 100% !important;
      max-width: 100% !important;
      background: linear-gradient(180deg, var(--topbar-a), var(--topbar-b));
      color: var(--topbar-fg);
      border-bottom: 1px solid var(--topbar-border);
      /* Tránh layout shift khi load */
      contain: layout style;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      margin: 0 !important;
      padding: 0 var(--topbar-pad-x, 10px) !important;

      display:grid !important;
      grid-template-columns: 1fr 0fr 1fr;
      align-items:center;
    }

    .tbLeft{ justify-self:start; display:flex; align-items:center; }
    .tbCenter{ justify-self:center; }
    .tbRight{ justify-self:end; display:flex; align-items:center; gap:10px; }

    .app{
      height: calc(100vh - var(--topbar-h, 28px)) !important; /* Fallback để tránh layout shift */
      height: calc(100dvh - var(--topbar-h, 28px)) !important;
      width: 100% !important;
      max-width: 100% !important;
      display:flex !important;
      gap: 0 !important; /* Không có gap */
      overflow:hidden !important;
      margin: 0 !important;
      padding: 0 !important;
      /* Tránh layout shift khi load */
      contain: layout;
    }

    /* Phần giữa - fill khoảng trống */
    .middlePane{
      flex: 1 1 auto; /* Fill khoảng trống còn lại */
      min-width: 0;
      background: var(--bg); /* Nền chính */
      overflow: hidden;
    }

    .leftPane{
      width: 200px; /* Width cố định 200px */
      min-width: 200px;
      max-width: 200px;
      flex-shrink: 0; /* Không co lại */
      background:var(--bg-soft);
      display:flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      border-right:1px solid var(--border);
      margin: 0; /* Không có margin */
      padding: 0; /* Padding được handle bởi sidebarMenu */
    }

    .coming{
      max-width:640px;
      width:100%;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      box-shadow: none;
      text-align: center;
    }
    .coming .badge{
      display: none;
    }
    .coming h1{
      display: none;
    }
    .coming p{
      display: none;
    }
    .coming::before{
      content: "Coming soon";
      display: block;
      font-size: 72px;
      font-weight: 300;
      letter-spacing: 0.05em;
      color: var(--muted);
      opacity: 0.25;
      line-height: 1;
      
      /* Glow effect nhẹ */
      text-shadow: 
        0 0 20px rgba(108, 98, 90, 0.15),
        0 0 40px rgba(108, 98, 90, 0.08);
    }

    /* Dark mode: glow mạnh hơn một chút */
    :root[data-theme="dark"] .coming::before{
      text-shadow: 
        0 0 24px rgba(185, 176, 166, 0.20),
        0 0 48px rgba(185, 176, 166, 0.10),
        0 0 72px rgba(185, 176, 166, 0.05);
    }

    .chat{
      width: var(--chat-w, 380px); /* Fallback để tránh layout shift */
      min-width: var(--chat-min-w, 280px);
      max-width: var(--chat-max-w, 560px);
      flex-shrink: 0; /* Không co lại */

      height:100%;
      min-height:0;
      overflow:hidden;
      background:var(--panel);
      /* Tránh layout shift khi load */
      contain: layout style;
      box-shadow:
        -10px 0 24px rgba(0,0,0,0.12),
        -2px 0 6px rgba(0,0,0,0.08);
      display:flex;
      flex-direction:column;
      position: relative; /* để gắn resizer */
    }

    :root[data-theme="dark"] .chat{
      box-shadow:
        -10px 0 24px rgba(0,0,0,0.50),
        -2px 0 6px rgba(0,0,0,0.35);
    }

    .wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .scrollArea{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:
        calc(var(--msg-top-inset) + env(safe-area-inset-top, 0px))
        18px
        18px
        18px;
      scroll-behavior:smooth;
      scroll-padding-top:
        calc(var(--msg-top-inset) + env(safe-area-inset-top, 0px));
    }

    .messages{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .turn{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .ai{
      background: transparent;
      border: none;
      box-shadow: none;

      color: var(--aiText);
      font-size:15px;
      line-height:1.65;

      padding: 0;               /* KHÔNG padding */
      margin: 0;                /* spacing do .turn kiểm soát */

      max-width:100%;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .aiPlain{
      color: var(--aiText);
    }

    .aiRender > :first-child,
    .ai > :first-child{
      margin-top:0;
    }

    .aiRender > :last-child,
    .ai > :last-child{
      margin-bottom:0;
    }

    .aiRender > p{
      margin: 0 0 0.8em;
    }

    .userWrap{
      align-self:flex-end;
      display:inline-flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      max-width:85%;
      position:relative;
      margin-top:-3px;
    }
    
    /* Copy button nằm dưới user bubble */
    .userWrap .copyBtn{
      order: 2; /* Đặt copy button xuống dưới */
      margin-top: 2px;
      align-self: flex-end;
    }
    
    .userWrap .user{
      order: 1; /* User bubble ở trên */
    }

    .user{
      background: var(--userBubble);
      color: var(--userText);
      border: 1px solid var(--userBubbleBorder);

      border-radius:18px;
      padding:10px 14px;
      box-shadow: var(--shadow-soft);

      font-size:15px;
      line-height:1.35;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .userText{ display:block; }

    .copyBtn{
      width:22px;
      height:22px;
      border:none;
      border-radius:6px;
      background:transparent;
      color:#333;
      display:grid;
      place-items:center;
      cursor:pointer;
      opacity:0;
      transition: opacity 0.2s ease, background 0.2s ease, color 0.2s ease;
      pointer-events:none;
      position:relative;
    }

    .userWrap:hover .copyBtn,
    .copyBtn:focus-visible{
      opacity:1;
      pointer-events:auto;
    }

    .copyBtn:hover{ background: rgba(28,26,23,0.06); }

    :root[data-theme="dark"] .copyBtn{
      color: #cbd5e1;
    }

    :root[data-theme="dark"] .copyBtn:hover{
      background: rgba(226,232,240,0.08);
    }

    .copyBtn::after{
      content: attr(data-tooltip);
      position:absolute;
      right:0;
      bottom:calc(100% + 6px);
      padding:4px 6px;
      border-radius:6px;
      font-size:11px;
      background: var(--panel);
      border: 1px solid rgba(28,26,23,0.10);
      color: rgba(28,26,23,0.92);
      box-shadow:0 6px 14px rgba(15,17,21,0.12);
      white-space:nowrap;
      opacity:0;
      transform: translateY(2px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      pointer-events:none;
    }

    .copyBtn:hover::after,
    .copyBtn:focus-visible::after{
      opacity:1;
      transform: translateY(0);
    }

    .bar{
      padding:14px;
      border-top:1px solid var(--border);
      background:var(--panel);
      flex:0 0 auto;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Model selector container - bên trên chatComposer */
    .modelSelectorContainer{
      display: flex !important;
      align-items: center;
      padding-bottom: 6px; /* Giảm padding */
      min-height: 24px; /* Thu nhỏ */
      visibility: visible !important;
      opacity: 1 !important;
    }

    .chatComposer{
      --send-size: 30px;
      --send-icon-size: 20px;

      display:grid;
      grid-template-columns: 1fr var(--send-size);
      align-items:center;
      gap:12px;

      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 28px;
      box-shadow: var(--shadow-soft);

      padding: 8px 10px 8px 18px;
      min-height: 40px;
      max-height: 170px;
      overflow:hidden;
      /* FIX: Lock height để tránh nhảy */
      height: auto;
      contain: layout style; /* Optimize rendering */
    }

    /* ===== Model Selector - Glass Pill (Hướng A) ===== */
    /* Wrapper cho model pill với caret */
    .modelSelectorWrapper{
      position: relative;
      display: inline-flex !important;
      align-items: center;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* Model selector - Glass pill đồng bộ topbar */
    .modelSelector{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;

      height: var(--topbar-pill-h, 20px);
      padding: 0 28px 0 12px;          /* chừa chỗ cho caret */
      border-radius: 8px;               /* Bo tròn nhẹ hơn */

      border: 1px solid var(--model-border-subtle); /* Viền theo VS Code style */
      background: var(--model-bg); /* Đen sâu premium */
      color: var(--model-fg-main); /* Text chính off-white ấm */
      box-shadow: 0 3px 12px rgba(0,0,0,0.35), 0 2px 6px rgba(0,0,0,0.20); /* Hiệu ứng nổi mặc định */

      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.01em;

      cursor: pointer;
      user-select: none;

      outline: none;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", "Inter", "Roboto", system-ui, sans-serif;
      transition: background 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      min-width: 120px;
      line-height: 1;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 10;
    }

    /* Hover: theo VS Code style */
    .modelSelector:hover:not(:disabled) {
      background: var(--model-hover); /* rgba(255,255,255,0.08) */
      box-shadow: 0 4px 16px rgba(0,0,0,0.40), 0 3px 8px rgba(0,0,0,0.25);
      border-color: var(--model-border-subtle);
    }
    
    /* Active: theo VS Code style */
    .modelSelector:active:not(:disabled) {
      background: var(--model-active); /* rgba(255,255,255,0.12) */
    }

    /* Focus: ring mềm với màu accent */
    .modelSelector:focus-visible {
      box-shadow: 0 0 0 3px var(--model-accent-ring);
    }

    .modelSelector:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Caret (wrap trong container) */
    .modelSelectorWrapper::after{
      content: "▾";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-52%);
      pointer-events: none;
      font-size: 11px;
      opacity: 0.75;
      color: var(--topbar-fg);
    }
    
    /* Ẩn ::after khi dùng custom dropdown */
    .modelSelectorWrapper.hasCustomDropdown::after {
      display: none;
    }

    /* Dark mode - dùng CSS variables tự động, không cần override riêng */

    /* Custom dropdown list styles - VS Code style */
    .modelDropdownList {
      scrollbar-width: thin;
      scrollbar-color: var(--sb-thumb) var(--sb-track);
      background: var(--model-bg); /* Đen sâu premium */
      border: 1px solid var(--model-border-subtle); /* Viền theo VS Code style */
      color: var(--model-fg-main); /* Text chính */
      box-shadow: 0 -4px 16px rgba(0,0,0,0.30), 0 -2px 8px rgba(0,0,0,0.20);
    }

    .modelDropdownList::-webkit-scrollbar {
      width: 8px;
    }

    .modelDropdownList::-webkit-scrollbar-track {
      background: var(--sb-track);
      border-radius: 4px;
    }

    .modelDropdownList::-webkit-scrollbar-thumb {
      background: var(--sb-thumb);
      border-radius: 4px;
    }

    .modelDropdownList::-webkit-scrollbar-thumb:hover {
      background: var(--sb-thumb-hover);
    }

    /* Dark mode cho dropdown list - dùng CSS variables tự động, không cần override riêng */
    /* CSS variables đã tự động thay đổi theo theme */

    .chatComposer:focus-within{
      border-color: var(--border-soft);
      box-shadow:
        0 0 0 3px rgba(111,143,175,0.14),
        var(--shadow-soft);
    }

    .chatComposerInput{
      width:100%;
      min-width:0;
      border:none;
      outline:none;
      background:transparent;

      font-size:16px;
      font-family:inherit;
      line-height:1.5;
      text-align:left;

      resize:none;
      padding: 0;
      margin:0;
      max-height: 150px;

      overflow-x:hidden;
      overflow-y:auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      
      vertical-align:middle;

      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;

      color: var(--text);
      caret-color: rgba(28,26,23,0.65);
      
      /* FIX: Lock để tránh nhảy */
      box-sizing: border-box;
      transition: none; /* Tắt transition */
      contain: layout style; /* Optimize rendering */
    }

    .chatComposerInput::placeholder{
      color: var(--placeholder, rgba(138,128,119,0.75)); /* Dùng biến CSS và tăng opacity để rõ hơn trong light mode */
    }

    :root[data-theme="dark"] .chatComposer{
      background: #181512; /* sáng hơn panel 1 chút */
    }

    :root[data-theme="dark"] .chatComposerInput{
      color: #f1ebe3;              /* trắng ngà, KHÔNG trắng gắt */
      caret-color: #e6dccf;        /* con trỏ rõ nhưng dịu */
    }

    :root[data-theme="dark"] .chatComposerInput::placeholder{
      color: rgba(241,235,227,0.45);
    }

    .chatSend{
      width:var(--send-size);
      height:var(--send-size);
      border-radius:50%;
      border:none;
      background: #1c1a17;   /* charcoal ấm */
      color: var(--panel);
      cursor:pointer;

      display:grid;
      place-items:center;
      padding:0;
      line-height:0;
    }

    .chatSend:disabled{
      background: rgba(28,26,23,0.35);
      color: rgba(251,248,243,0.85);
      cursor:not-allowed;
    }

    :root[data-theme="dark"] .chatSend{
      background: #e6dccf;   /* beige sáng */
      color: #141210;        /* chữ/icon tối */
    }

    :root[data-theme="dark"] .chatSend:disabled{
      background: rgba(230,220,207,0.35);
      color: rgba(20,18,16,0.55);
    }

    .sendIcon{
      width:var(--send-icon-size);
      height:var(--send-icon-size);
      display:block;
    }


    /* ===== Topbar resizer (drag like Cursor) ===== */
    .topbarResizer{
      position:absolute;
      left:0;
      right:0;
      bottom:-3px;              /* "ăn" xuống app để dễ bắt */
      height:6px;               /* vùng hit */
      cursor: ns-resize;
      touch-action: none;       /* quan trọng cho mobile */
      background: transparent;
    }

    .topbarResizer::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      top:2px;                  /* line nằm giữa vùng hit */
      height:1px;
      background: rgba(255,255,255,0.10);
      opacity:0.0;
      transition: opacity 0.15s ease;
    }

    .topbar:hover .topbarResizer::after{
      opacity:0.9;
    }

    /* khi đang kéo */
    :root[data-resizing="topbar"] .topbarResizer::after{
      opacity:1;
      background: rgba(255,255,255,0.20);
    }

    /* ===== Chat resizer (drag like Cursor) ===== */
    .chatResizer{
      position:absolute;
      left:-8px;        /* "ăn" ra ngoài để dễ bắt hơn */
      top:0;
      bottom:0;
      width:16px;        /* vùng hit rộng hơn để dễ bắt */
      cursor: ew-resize;
      touch-action: none;
      background: transparent;
      z-index: 5;
    }

    .chatResizer::after{
      content:"";
      position:absolute;
      top:0;
      bottom:0;
      left:7px;          /* line nằm giữa vùng hit */
      width:1px;
      background: var(--border-soft);
      opacity:0.0;
      transition: opacity 0.15s ease;
    }

    .chat:hover .chatResizer::after{
      opacity:0.9;
    }

    /* khi đang kéo */
    :root[data-resizing="chat"] .chatResizer::after{
      opacity:1;
      background: var(--accent);
    }

    /* ===== Clock (kept) ===== */
    .clockWidget{
      height: var(--topbar-pill-h, 20px);
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:0 10px;
      border-radius:999px;

      border: 1px solid var(--clock-border);
      background: var(--clock-bg, var(--clock-glass)); /* Dùng --clock-bg nếu có, fallback về --clock-glass */
      color: var(--clock-fg);

      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.02em;
      user-select:none;
    }

    .clockSvg{ width:14px; height:14px; color: var(--clock-icon); }
    #clockTime{ font-variant-numeric: tabular-nums; }

    /* kim quay nhẹ */
    .clockHand{
      transform-origin: 12px 12px;
      animation: clockSpin 6s linear infinite;
    }
    @keyframes clockSpin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* ===== Cursor-like theme toggle (centered thumb) ===== */
    .themeToggle{
      /* sizing */
      --toggle-pad: 4px;
      --toggle-w: clamp(64px, calc(var(--topbar-pill-h, 20px) * 3.0), 84px);
      --thumb: calc(var(--topbar-pill-h, 20px) - 8px);
      --seg: calc((var(--toggle-w) - 2 * var(--toggle-pad)) / 2);
      --thumb-offset: calc((var(--seg) - var(--thumb)) / 2);

      position:relative;
      height: var(--topbar-pill-h, 20px);
      width: var(--toggle-w);

      border-radius: 999px;
      border: 1px solid var(--topbar-border);
      background: var(--topbar-glass);
      color: var(--topbar-fg);

      padding: 0 var(--toggle-pad);
      cursor:pointer;
      overflow:hidden;

      /* layout: 2 halves */
      display:grid;
      grid-template-columns: 1fr 1fr;
      align-items:center;
    }

    .themeToggle:hover{
      background: rgba(255,255,255,0.16);
    }

    /* Icon style: Lucide-like */
    .themeIcon{
      width: 16px;
      height: 16px;
      justify-self: center;
      align-self: center;
      z-index: 2;
      pointer-events: none;

      opacity: 0.62;                /* default = inactive */
      transition: opacity 180ms ease, transform 180ms ease;
    }

    .themeIcon.sun{ grid-column: 1; }
    .themeIcon.moon{ grid-column: 2; }

    /* Active icon: LIGHT => sun active */
    :root:not([data-theme="dark"]) .themeIcon.sun{
      opacity: 0.95;
      transform: translateY(-0.2px);
    }
    :root:not([data-theme="dark"]) .themeIcon.moon{
      opacity: 0.50;
    }

    /* Active icon: DARK => moon active */
    :root[data-theme="dark"] .themeIcon.moon{
      opacity: 0.95;
      transform: translateY(-0.2px);
    }
    :root[data-theme="dark"] .themeIcon.sun{
      opacity: 0.50;
    }

    .themeThumb{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);

      width: var(--thumb);
      height: var(--thumb);
      border-radius: 999px;

      left: calc(var(--toggle-pad) + var(--thumb-offset)); /* mặc định = LIGHT */
      transition: left 180ms ease;

      background: rgba(255,255,255,0.65);
      box-shadow: 0 6px 16px rgba(0,0,0,0.16);

      z-index: 1;
      pointer-events:none;
    }

    /* DARK: thumb sang nửa phải, đúng tâm icon moon */
    :root[data-theme="dark"] .themeThumb{
      left: calc(var(--toggle-pad) + var(--seg) + var(--thumb-offset));
      background: rgba(236,230,221,0.22);
      box-shadow: 0 10px 22px rgba(0,0,0,0.42);
    }

    .thinkingText{
      display:inline-block;
      background:linear-gradient(
        90deg,
        #b79f7a 0%,
        #9d8265 42%,
        #a8927a 75%,
        rgba(183,159,122,0.3) 100%
      );
      background-size:220% 100%;
      color:#9d8265;
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
      animation: thinkingShimmer 1.4s ease infinite;
    }

    @keyframes thinkingShimmer{
      0%{ background-position:0 0; }
      100%{ background-position:200% 0; }
    }

    :root[data-theme="dark"] .aiPlain{
      color: #f1ebe3; /* Đảm bảo aiPlain có màu trong dark mode */
    }

    /* Dark mode styles cho Markdown - COMMENTED: sẽ dùng VS Code theme thay thế */
    /* 
    :root[data-theme="dark"] .ai code{
      background: rgba(255,255,255,0.1);
      color: #e6dccf;
    }

    :root[data-theme="dark"] .ai pre{
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }

    :root[data-theme="dark"] .ai pre code{
      background: transparent;
    }
    */

    :root[data-theme="dark"] .ai blockquote{
      border-left-color: rgba(255,255,255,0.3);
      color: rgba(241,235,227,0.8);
    }

    :root[data-theme="dark"] .ai a{
      color: #7cb3f0;
    }

    :root[data-theme="dark"] .ai a:hover{
      color: #9cc5f5;
    }

    :root[data-theme="dark"] .ai table{
      border-color: rgba(255,255,255,0.15);
    }

    :root[data-theme="dark"] .ai th{
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.15);
    }

    :root[data-theme="dark"] .ai td{
      border-color: rgba(255,255,255,0.15);
    }

    :root[data-theme="dark"] .thinkingText{
      /* Gradient động cho dark mode */
      background: linear-gradient(
        90deg,
        rgba(241,235,227,0.50) 0%,
        rgba(241,235,227,0.85) 42%,
        rgba(241,235,227,0.70) 75%,
        rgba(241,235,227,0.30) 100%
      );
      background-size: 220% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: thinkingShimmerDark 1.4s ease infinite;
    }
    
    @keyframes thinkingShimmerDark{
      0%{ background-position:0 0; }
      100%{ background-position:200% 0; }
    }

    /* ===== Scrollbar styling (WebKit) ===== */
    .scrollArea::-webkit-scrollbar{
      width: 10px;
    }

    /* Ẩn scrollbar cho textarea input */
    .chatComposerInput::-webkit-scrollbar{
      display: none;
      width: 0;
      height: 0;
    }

    .scrollArea::-webkit-scrollbar-track{
      background: var(--sb-track);
      border-radius: 999px;
    }

    .chatComposerInput::-webkit-scrollbar-track{
      display: none;
    }

    .scrollArea::-webkit-scrollbar-thumb{
      background: var(--sb-thumb);
      border-radius: 999px;
      border: 3px solid transparent;       /* tạo "pill" mảnh, tinh tế */
      background-clip: content-box;
    }

    .chatComposerInput::-webkit-scrollbar-thumb{
      display: none;
    }

    .scrollArea::-webkit-scrollbar-thumb:hover{
      background: var(--sb-thumb-hover);
      background-clip: content-box;
    }

    .chatComposerInput::-webkit-scrollbar-thumb:hover{
      display: none;
    }

    /* ===== Scrollbar styling (Firefox) ===== */
    .scrollArea{
      scrollbar-width: thin;
      scrollbar-color: var(--sb-thumb) var(--sb-track);
    }

    /* Ẩn scrollbar cho textarea (Firefox) */
    .chatComposerInput{
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    /* ===== HTML scrollbar ===== */
    html{
      scrollbar-color: var(--sb-thumb) var(--sb-track);
    }
    html::-webkit-scrollbar{ width: 10px; }
    html::-webkit-scrollbar-track{ background: var(--sb-track); }
    html::-webkit-scrollbar-thumb{
      background: var(--sb-thumb);
      border-radius: 999px;
      border: 3px solid transparent;
      background-clip: content-box;
    }
    html::-webkit-scrollbar-thumb:hover{
      background: var(--sb-thumb-hover);
      background-clip: content-box;
    }

    /* =========================================================
       Code Block SSOT (Light + Dark) - VS Code theme
       ========================================================= */

    /* CRITICAL: Đảm bảo UI chính luôn hiển thị */
    .app[data-react="true"] { 
      display: flex !important; 
    }
    .topbar[data-react="true"] { 
      display: grid !important; 
    }
    .chat[data-react="true"] {
      display: flex !important;
    }

    /* ========== Code Block SSOT (Light + Dark) ========== */
    :root{
      --code-bg: #ffffff;              /* VS Code Light+ surface */
      --code-border: #e5e5e5;
      --code-header-bg: #f6f6f6;
      --code-header-fg: #333;
      --code-copy-bg: transparent;
      --code-copy-fg: #333;
    }

    :root[data-theme="dark"]{
      /* Code block - ĐEN HẲN, đúng tông */
      --code-bg: #141210;              /* Đen ấm, cùng hệ với panel/chat */
      --code-border: rgba(255,255,255,0.10); /* Viền nhẹ, chỉ để tách khối */
      --code-header-bg: #121110;       /* Header đậm hơn 1 nấc */
      --code-header-fg: #ECE6DD;       /* Chữ off-white ấm */
      --code-copy-bg: transparent;
      --code-copy-fg: #ECE6DD;         /* Chữ off-white ấm */
      /* Syntax colors */
      --code-text: #ECE6DD;            /* Chữ code base - off-white ấm */
      --code-comment: rgba(236,230,221,0.55); /* Comment - dịu xuống nhưng cùng hue */
      --code-keyword: #9FB7A6;         /* Keyword - sage khói, không xanh gắt */
      --code-string: #D4B77C;          /* String/literal - champagne */
    }

    /* Wrapper của code block */
    .codeBlock{
      background: var(--code-bg);
      border: 1px solid var(--code-border);
      border-radius: 8px; /* Bo góc rõ ràng hơn */
      overflow: hidden; /* Đảm bảo bo góc hoạt động đúng */
      box-shadow: none;
    }

    /* Header (PYTHON + Copy) phải cùng "hệ màu" */
    .codeBlockHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      background: var(--code-header-bg);
      color: var(--code-header-fg);
      border-bottom: 1px solid var(--code-border);
      border-radius: 8px 8px 0 0; /* Bo góc trên để khớp với wrapper */
      position: relative;
      z-index: 10;
      min-height: 48px; /* Height cố định để tránh giãn */
      box-sizing: border-box; /* Đảm bảo padding tính trong height */
    }

    .codeLangTag{
      font-size: 12px;
      font-weight: 700;
      opacity: 0.9;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(127,127,127,0.12);
    }

    .codeCopyBtn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      font-weight: 700;
      border: 0;
      background: var(--code-copy-bg);
      color: var(--code-copy-fg);
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 8px;
      position: relative;
      z-index: 11;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      min-width: 60px; /* Width cố định để tránh nhảy khi text thay đổi */
      height: 28px; /* Height cố định để tránh code block bị giãn */
      line-height: 1; /* Line height cố định */
      justify-content: center; /* Căn giữa text */
      box-sizing: border-box; /* Đảm bảo padding tính trong height */
    }
    .codeCopyBtn:hover{
      background: rgba(127,127,127,0.12);
    }
    .codeCopyBtn:active{
      transform: scale(0.98);
    }

    /* Ép pre/code đồng nhất nền (quan trọng) */
    .codeBlock pre{
      margin: 0 !important;
      background: var(--code-bg) !important;
      border: 0 !important;
      border-radius: 0 0 8px 8px !important; /* Bo góc dưới để khớp với wrapper */
      box-shadow: none !important;
      overflow: visible !important;
      max-height: none !important;
      height: auto !important;
    }

    .codeBlock pre code{
      background: transparent !important;
      color: var(--code-text, #ECE6DD) !important; /* Chữ code base */
    }

    /* Override syntax highlighting colors cho dark mode */
    :root[data-theme="dark"] .codeBlock pre code .token.comment,
    :root[data-theme="dark"] .codeBlock pre code .token.prolog,
    :root[data-theme="dark"] .codeBlock pre code .token.doctype,
    :root[data-theme="dark"] .codeBlock pre code .token.cdata {
      color: var(--code-comment, rgba(236,230,221,0.55)) !important;
    }

    :root[data-theme="dark"] .codeBlock pre code .token.keyword,
    :root[data-theme="dark"] .codeBlock pre code .token.selector,
    :root[data-theme="dark"] .codeBlock pre code .token.attr-name,
    :root[data-theme="dark"] .codeBlock pre code .token.property,
    :root[data-theme="dark"] .codeBlock pre code .token.class-name,
    :root[data-theme="dark"] .codeBlock pre code .token.function {
      color: var(--code-keyword, #9FB7A6) !important; /* Sage khói */
    }

    :root[data-theme="dark"] .codeBlock pre code .token.string,
    :root[data-theme="dark"] .codeBlock pre code .token.char,
    :root[data-theme="dark"] .codeBlock pre code .token.attr-value,
    :root[data-theme="dark"] .codeBlock pre code .token.regex,
    :root[data-theme="dark"] .codeBlock pre code .token.variable {
      color: var(--code-string, #D4B77C) !important; /* Champagne */
    }

    /* Inline code (không phải block) */
    .ai :not(pre) > code{
      background: rgba(127,127,127,0.14) !important;
      border: 1px solid rgba(127,127,127,0.18);
      border-radius: 6px;
      padding: 0.15em 0.35em;
    }

    /* Bỏ scroll hoàn toàn - code hiển thị đầy đủ */
    .codeBlock pre {
      overflow: visible !important;
      max-height: none !important;
      height: auto !important;
    }
    .codeBlock pre::-webkit-scrollbar { 
      display: none;
    }

    /* ===== Sidebar Menu ===== */
    .sidebarMenu {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 16px;
      box-sizing: border-box; /* Padding tính trong width */
      position: relative;
    }

    /* List section (phần trên) */
    .sidebarListSection {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      min-height: 0;
    }

    /* Separator line */
    .sidebarSeparator {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
      flex-shrink: 0;
    }

    /* User profile section (phần dưới) - y hệt như hình, gần đáy */
    .sidebarUserProfile {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px 0;
      flex-shrink: 0;
      background: transparent;
      margin-top: auto; /* Đẩy xuống gần đáy */
    }

    .sidebarUserInfoRow {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebarUserAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background: rgba(255,255,255,0.1); /* Nền xám đậm hơn một chút */
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .sidebarAvatarImg {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .sidebarAvatarPlaceholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #fff; /* Chữ trắng */
      background: transparent;
    }

    .sidebarUserText {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }

    .sidebarUserName {
      font-size: 14px;
      font-weight: 600;
      color: var(--text); /* Màu trắng */
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebarUserSubInfo {
      font-size: 12px;
      font-weight: 400;
      color: var(--muted); /* Màu xám nhẹ hơn */
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* User actions (đăng xuất) */
    .sidebarUserActions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebarSignOutBtn {
      width: 100%;
      padding: 8px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
      font-family: inherit;
    }

    .sidebarSignOutBtn:hover {
      background: var(--hover, rgba(255,255,255,0.08));
      border-color: var(--border-soft);
    }

    /* Auth switch link */
    .sidebarAuthSwitch {
      margin-top: 12px;
    }

    .sidebarAuthSwitch a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }

    .sidebarAuthSwitch a:hover {
      text-decoration: underline;
    }

    /* Auth section khi chưa đăng nhập */
    .sidebarAuthSection {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebarAuthHeader {
      text-align: center;
      margin-bottom: 8px;
    }

    .sidebarAuthTitle {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 8px 0;
    }

    .sidebarAuthSubtitle {
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    .sidebarAuthForms {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebarSignIn {
      width: 100%;
    }

    /* Clerk components styling - override để fit sidebar */
    .sidebarAuthForms [data-clerk-element] {
      width: 100% !important;
      max-width: 100% !important;
    }

    .sidebarAuthForms .cl-rootBox {
      width: 100% !important;
      max-width: 100% !important;
    }

    .sidebarAuthForms .cl-card {
      width: 100% !important;
      max-width: 100% !important;
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      border-radius: 8px !important;
      padding: 16px !important;
      box-shadow: none !important;
    }

    .sidebarAuthForms .cl-headerTitle {
      font-size: 16px !important;
      font-weight: 700 !important;
      color: var(--text) !important;
    }

    .sidebarAuthForms .cl-headerSubtitle {
      font-size: 12px !important;
      color: var(--muted) !important;
    }

    .sidebarAuthForms .cl-formButtonPrimary {
      background: var(--accent) !important;
      color: var(--text) !important;
      border-radius: 6px !important;
      font-weight: 600 !important;
      transition: background 0.2s ease !important;
    }

    .sidebarAuthForms .cl-formButtonPrimary:hover {
      opacity: 0.9 !important;
    }

    .sidebarAuthForms .cl-formFieldInput {
      background: var(--bg-soft) !important;
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
      color: var(--text) !important;
    }

    .sidebarAuthForms .cl-footerActionLink {
      color: var(--accent) !important;
    }

    /* Scrollbar cho sidebar */
    .leftPane::-webkit-scrollbar {
      width: 6px;
    }

    .leftPane::-webkit-scrollbar-track {
      background: transparent;
    }

    .leftPane::-webkit-scrollbar-thumb {
      background: var(--sb-thumb);
      border-radius: 3px;
    }

    .leftPane::-webkit-scrollbar-thumb:hover {
      background: var(--sb-thumb-hover);
    }

    .leftPane {
      scrollbar-width: thin;
      scrollbar-color: var(--sb-thumb) transparent;
    }
  </style>
</head>

<body>
  <!-- React sẽ render toàn bộ UI vào #root -->
  <div id="root"></div>
  <script type="module" src="/src/main-clerk.jsx"></script>
</body>
</html>
