<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>web_ui – Chat (Standalone)</title>

  <!-- CRITICAL: Apply theme và kích thước TRƯỚC khi CSS render -->
  <!-- Script này PHẢI chạy trước <style> tag để set CSS variables ngay -->
  <script>
    // IIFE chạy ngay khi parse, TRƯỚC khi CSS được apply
    (function() {
      'use strict';
      const root = document.documentElement;
      
      try {
        // 1. Apply theme trước
        const THEME_KEY = "ui_theme";
        const saved = localStorage.getItem(THEME_KEY);
        const systemDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme = saved === "dark" || saved === "light" ? saved : (systemDark ? "dark" : "light");
        root.setAttribute("data-theme", theme);
        
        // 2. Apply topbar height từ ideal (rem) - QUAN TRỌNG: phải set TRƯỚC khi CSS parse
        const TOPBAR_IDEAL_KEY = "ui_topbar_ideal_rem";
        const TOPBAR_MIN_PX = 20;
        const TOPBAR_MAX_PX = 56;
        const TOPBAR_DEFAULT_REM = 2.0;
        
        // Helper để đọc số từ localStorage
        function readNumberLS(key, fallback) {
          const raw = localStorage.getItem(key);
          const n = raw == null ? NaN : parseFloat(raw);
          return Number.isFinite(n) ? n : fallback;
        }
        
        // Lấy ideal rem từ localStorage, fallback về default
        const topbarIdealRem = readNumberLS(TOPBAR_IDEAL_KEY, TOPBAR_DEFAULT_REM);
        
        // Tính remPx từ font-size (mặc định 16px nếu chưa có)
        // Dùng cách an toàn: thử getComputedStyle, nếu không có thì dùng 16
        let remPx = 16;
        try {
          const fs = getComputedStyle(root).fontSize;
          const parsed = parseFloat(fs);
          if (Number.isFinite(parsed) && parsed > 0) {
            remPx = parsed;
          }
        } catch(e) {
          // Fallback về 16 nếu chưa có computed style
        }
        
        const idealPx = topbarIdealRem * remPx;
        const clamped = Math.max(TOPBAR_MIN_PX, Math.min(TOPBAR_MAX_PX, idealPx));
        const pillH = Math.max(16, Math.min(34, Math.round(clamped * 0.64)));
        // Set inline style - có priority cao nhất
        root.style.setProperty("--topbar-h", clamped + "px");
        root.style.setProperty("--topbar-pill-h", pillH + "px");
        
        // 3. Apply chat width từ ideal (vw) - QUAN TRỌNG: phải set TRƯỚC khi CSS parse
        const CHAT_IDEAL_KEY = "ui_chat_ideal_vw";
        const CHAT_MIN_PX = 280;
        const CHAT_MAX_PX = 560;
        const CHAT_DEFAULT_VW = 28;
        
        // Lấy ideal vw từ localStorage, fallback về default
        const chatIdealVw = readNumberLS(CHAT_IDEAL_KEY, CHAT_DEFAULT_VW);
        
        // Tính vwPx từ viewport width (an toàn với window.innerWidth)
        const vwPx = (typeof window !== 'undefined' && window.innerWidth) ? window.innerWidth / 100 : 3.8;
        const chatIdealPx = chatIdealVw * vwPx;
        const chatClamped = Math.max(CHAT_MIN_PX, Math.min(CHAT_MAX_PX, chatIdealPx));
        // Set inline style - có priority cao nhất
        root.style.setProperty("--chat-w", chatClamped + "px");
      } catch(e) {
        // Fallback nếu localStorage bị block
        console.warn("Error applying saved UI settings:", e);
      }
    })();
  </script>

  <!-- CSS chính - script trên đã set inline style cho CSS variables -->
  <style>
    :root{
      /* ===== Core Surfaces ===== */
      --desk: #EEEAE2;                 /* Middle pane backdrop (desk) */
      --desk-deep: #E4DED5;            /* vignette/edges */
      --desk-top-wash: #F3EFE7;        /* desk top wash - sáng hơn ở mép trên */
      --bg: var(--desk);               /* keep compatibility */
      --bg-soft: #F1EDE6;              /* left pane base */
      --panel: #F3EFE7;                /* chat panel base */
      --panel-2: #EEE8DE;              /* inner surfaces */
      --header-wash-start: rgba(255,255,255,0.45); /* Header wash start */
      --header-wash-mid: rgba(255,255,255,0.15);   /* Header wash mid */
      --rail-top-wash: rgba(255,255,255,0.15);     /* Rail top wash */

      /* ===== Paper (Hero Writing Surface) ===== */
      --paper: #FFFCF6;                /* premium neutral ivory */
      --paper-tint: #F7F2E9;           /* subtle wash */
      --paper-edge: rgba(28,26,23,0.10);
      --paper-inner: rgba(255,255,255,0.78);
      --paper-text: rgba(27,25,22,0.89); /* Giảm contrast 2-3% (0.92→0.89), thêm chút brown/olive thay vì neutral gray */
      --paper-inner-warm: #FBF7EE;     /* Paper inner warm layer */
      --paper-cool-break: #FAF6EF;     /* Paper cool break layer */
      --paper-top-highlight-start: rgba(255,255,255,0.75); /* Top edge highlight start */
      --paper-top-highlight-mid: rgba(255,255,255,0.35);   /* Top edge highlight mid */
      --paper-bottom-lift: rgba(255,255,255,0.06);          /* Bottom lift highlight */

      /* ===== Ink System v2 - "BÚT BI MẢNH" (LIGHT) ===== */
      /* Ink palette - NHẠT + TRUNG TÍNH HƠN (giảm 1 level so với cũ) */
      --ink-core: #3A3530;
      --ink-mid: #45403A;
      --ink-soft: #504A43;
      --ink-edge: #6A635A;
      /* Text fill gradient - CHỈ 2 STOP, RẤT NHẸ (không có middle) */
      --ink-gradient-top: #3A3530;
      --ink-gradient-bottom: #45403A;
      /* Edge handling - GIẢM CỰC MẠNH, không outer feather */
      --ink-edge-blend: rgba(106, 99, 90, 0.28); /* rgba(#6A635A, 0.28) */
      /* Selection highlight - Giảm opacity để không "đè mực" */
      --selection-bg-ink: rgba(210, 195, 165, 0.22);
      --selection-edge-ink: rgba(150, 120, 80, 0.18);
      /* Caret */
      --caret-ink: rgba(90, 75, 55, 0.65);

      /* ===== Typography ===== */
      --text: #1B1916;
      --muted: rgba(27,25,22,0.58);
      --muted-2: rgba(27,25,22,0.42);
      --header-text: rgba(27,25,22,0.60); /* Header text với độ đậm cao hơn để dễ đọc */
      --placeholder: #8a8077;

      /* ===== Bubbles (LIGHT) ===== */
      /* User: warm latte (rõ hơn nền/panel) */
      --userBubble: #efe1cf;
      --userBubbleBorder: rgba(28,26,23,0.14);
      --userText: #1c1a17;

      /* AI: text block (document-like, không bubble) */
      --aiText: rgba(28,26,23,0.92);
      
      /* ===== Borders / Dividers ===== */
      --border: rgba(27,25,22,0.12);
      --border-soft: rgba(27,25,22,0.08);
      --divider: rgba(27,25,22,0.10);

      /* ===== Accent ===== */
      --accent: #B59A6A;               /* champagne */
      --accent-2: #8EAA9A;             /* sage */
      --accent-ring: rgba(181,154,106,0.26);

      /* ===== Interactions ===== */
      --hover: rgba(27,25,22,0.04);
      --active: rgba(27,25,22,0.07);
      --focus: rgba(181,154,106,0.22);

      /* ===== Send Button (Primary Action) ===== */
      --send-bg: #1B1916;                    /* warm charcoal */
      --send-fg: #FFFCF6;                    /* paper white */
      --send-border: rgba(0,0,0,0.18);
      --send-hover-bg: #2A2723;              /* nhấc sáng nhẹ */
      --send-active-bg: #141210;             /* nhấn xuống */
      --send-disabled-bg: rgba(27,25,22,0.32);
      --send-disabled-fg: rgba(255,252,246,0.55);
      --send-shadow: 0 6px 16px rgba(0,0,0,0.28);

      /* ===== Copy Button (Hover / Active / Copied) ===== */
      --copy-hover-bg: rgba(27,25,22,0.06);
      --copy-active-bg: rgba(27,25,22,0.10);
      --copy-fg: rgba(27,25,22,0.75);
      --copy-fg-active: rgba(27,25,22,0.92);
      --copy-success: #8EAA9A;               /* sage – calm success */
      --copy-success-bg: rgba(142,170,154,0.18);

      /* ===== Dropdown Underline (Model Selector / Menu) ===== */
      --dropdown-underline: rgba(181,154,106,0.55);   /* champagne */
      --dropdown-underline-hover: rgba(181,154,106,0.78);
      --dropdown-underline-active: #B59A6A;
      --dropdown-item-fg: rgba(27,25,22,0.88);
      --dropdown-item-muted: rgba(27,25,22,0.52);

      /* ===== Selection Highlight (Text Selection) ===== */
      --selection-bg: rgba(181,154,106,0.28);   /* champagne wash */
      --selection-fg: #1B1916;
      --selection-ui-bg: rgba(181,154,106,0.18);
      /* Ink-specific selection (for paper editor) */
      --selection-bg-ink: rgba(196, 176, 140, 0.28);
      --selection-edge-ink: rgba(150, 120, 80, 0.18);

      /* ===== Focus Ring (Keyboard / Accessibility) ===== */
      --focus-ring: 0 0 0 3px rgba(181,154,106,0.26);

      /* ===== WritingPane Lines ===== */
      --grid: rgba(27,25,22,0.094); /* Giảm 15% từ 0.11 */
      --grid-strong: rgba(27,25,22,0.128); /* Giảm 15% từ 0.15 */
      --margin: rgba(120, 62, 58, 0.16);

      /* ===== Shadows (Paper wins) ===== */
      --shadow-paper: 0 24px 80px rgba(0,0,0,0.28), 0 8px 24px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.12);
      --shadow-panel: -8px 0 18px rgba(0,0,0,0.10), -2px 0 6px rgba(0,0,0,0.06);
      --shadow-soft: 0 8px 26px rgba(0,0,0,0.10);
      /* Paper side shadows - ambient color với fade dọc */
      --paper-shadow-side-start: rgba(0,0,0,0);
      --paper-shadow-side-15: rgba(0,0,0,0.02);
      --paper-shadow-side-40: rgba(0,0,0,0.04);
      --paper-shadow-side-65: rgba(0,0,0,0.06);
      --paper-shadow-side-85: rgba(0,0,0,0.08);
      --paper-shadow-side-95: rgba(0,0,0,0.10);
      --paper-shadow-side-end: rgba(0,0,0,0.08);

      --msg-top-inset: 5px;

      /* ===== Topbar sizing (SSOT) ===== */
      --topbar-h: 28px;     /* chỉnh chiều cao topbar ở đây */
      --topbar-pad-x: 10px; /* padding ngang cho nút/clock */
      --topbar-pill-h: 18px;/* chiều cao "pill" (clock/toggle) bên trong */

      /* ===== Chat sizing (SSOT) ===== */
      --chat-w: 380px;          /* width mặc định của panel chat */
      --chat-min-w: 280px;
      --chat-max-w: 560px;      /* tuỳ bạn muốn */

      /* =========================
         TOPBAR + CLOCK — LIGHT
         ========================= */

      /* Topbar: match desk */
      --topbar-a: #EEEAE2;                       /* match desk */
      --topbar-b: #F2EEE7;                       /* slightly lifted */
      --topbar-fg: var(--text);
      --topbar-border: rgba(27,25,22,0.10);
      --topbar-glass: rgba(255,255,255,0.52);

      /* Clock (NO-PILL) — COLOR SPEC */
      --clock-bg: transparent;
      --clock-border: transparent;
      --clock-fg: rgba(60, 54, 48, 0.55); /* Time text - đọc được nhưng nhẹ hơn header meta */
      --clock-icon: rgba(60, 54, 48, 0.40); /* Icon nhẹ hơn text 1 nấc */
      --clock-fg-hover: rgba(60, 54, 48, 0.68); /* Hover text */
      --clock-icon-hover: rgba(60, 54, 48, 0.52); /* Hover icon */

      /* Pills */
      --pill-hover: rgba(27,25,22,0.05);
      --pill-active: rgba(27,25,22,0.08);

      /* ===== Chat Panel System (Model Selector / Dropdown / Composer) ===== */
      --chat-bg: var(--panel);
      --chat-border: rgba(27,25,22,0.10);
      --chat-fg: var(--text);
      --chat-muted: var(--muted);

      --model-bg: rgba(255,255,255,0.50);
      --model-bg-hover: rgba(255,255,255,0.66);
      --model-fg-main: var(--text);
      --model-fg-muted: var(--muted);
      --model-border-subtle: rgba(27,25,22,0.12);
      --model-hover: rgba(27,25,22,0.04);
      --model-active: rgba(27,25,22,0.07);
      --model-tick: #B59A6A;
      --model-accent: #8EAA9A;
      --model-accent-ring: rgba(142,170,154,0.22);

      /* ===== Scrollbar Rail (LIGHT) - Neutral Ivory ===== */
      --rail-base: #E7E1D8;                    /* Rail base - tối hơn desk 1 nấc */
      --rail-wash-top: #EEE8DF;                /* Rail inner wash top */
      --rail-wash-mid: #E3DDD4;                /* Rail inner wash mid */
      --rail-wash-bot: #DED7CD;                /* Rail inner wash bot */
      --rail-edge: rgba(27,25,22,0.08);        /* Rail edge line */
      --rail-edge-soft: rgba(27,25,22,0.05);   /* Rail edge soft */
      --sb-track: var(--rail-base);            /* Track dùng rail base */
      --sb-thumb: rgba(27,25,22,0.20);         /* THUMB */
      --sb-thumb-hover: rgba(27,25,22,0.28);   /* THUMB_HOVER */
    }

    :root[data-theme="dark"]{
      /* ===== Core Surfaces ===== */
      --desk: #141210;                 /* Desk base - tối hơn paper để paper nổi */
      --desk-deep: #100F0D;            /* Desk bottom - tối nhất */
      --desk-top-wash: #141210;        /* Desk top wash - dark mode (cùng với desk base) */
      --bg: var(--desk);
      --bg-soft: #0F0E0C;              /* left pane base */
      --panel: #12110F;                /* chat panel base */
      --panel-2: #151310;
      --header-wash-start: rgba(255,255,255,0.08); /* Header wash start - dark mode */
      --header-wash-mid: rgba(255,255,255,0.04);    /* Header wash mid - dark mode */
      --rail-top-wash: rgba(255,255,255,0.06);      /* Rail top wash - dark mode */

      /* ===== Paper (Hero Writing Surface) ===== */
      --paper: #1E1B17;                /* breathable dark ivory */
      --paper-tint: #221E1A;
      --paper-edge: rgba(255,255,255,0.10);
      --paper-inner: rgba(255,255,255,0.07);
      --paper-text: rgba(236,230,221,0.87); /* Giảm contrast 2-3% (0.90→0.87) cho dark mode */
      --paper-inner-warm: #211D19;     /* Paper inner warm layer - dark mode */
      --paper-cool-break: #1F1C18;     /* Paper cool break layer - dark mode */
      --paper-top-highlight-start: rgba(255,255,255,0.12); /* Top edge highlight start - dark mode */
      --paper-top-highlight-mid: rgba(255,255,255,0.06);    /* Top edge highlight mid - dark mode */
      --paper-bottom-lift: rgba(255,255,255,0.04);          /* Bottom lift highlight - dark mode */

      /* ===== Typography ===== */
      --text: #ECE6DD;
      --muted: rgba(236,230,221,0.68);
      --muted-2: rgba(236,230,221,0.52);
      --header-text: rgba(236,230,221,0.70); /* Header text với độ đậm cao hơn để dễ đọc - dark mode */
      --placeholder: #8f877f;

      /* ===== Ink System v2 - "BÚT BI MẢNH" (DARK) ===== */
      /* Ink palette - Sáng hơn cho dark mode, nhưng vẫn mảnh */
      --ink-core: #C4BDB5;
      --ink-mid: #D0C9C1;
      --ink-soft: #D8D1C9;
      --ink-edge: #E0D9D1;
      /* Text fill gradient - CHỈ 2 STOP, RẤT NHẸ (không có middle) */
      --ink-gradient-top: #C4BDB5;
      --ink-gradient-bottom: #D0C9C1;
      /* Edge handling - GIẢM CỰC MẠNH, không outer feather */
      --ink-edge-blend: rgba(224, 217, 209, 0.28); /* rgba(#E0D9D1, 0.28) */
      /* Selection highlight - Giảm opacity để không "đè mực" */
      --selection-bg-ink: rgba(210, 195, 165, 0.22);
      --selection-edge-ink: rgba(150, 120, 80, 0.18);
      /* Caret */
      --caret-ink: rgba(230, 220, 200, 0.75);

      /* ===== Bubbles (DARK) ===== */
      /* User: warm cocoa (nổi trên panel tối) */
      --userBubble: #241f1a;
      --userBubbleBorder: rgba(236,230,221,0.14);
      --userText: #f1ebe3;

      /* AI: text block (document-like, không bubble) */
      --aiText: rgba(236,230,221,0.92);

      /* ===== Borders / Dividers ===== */
      --border: rgba(255,255,255,0.12);
      --border-soft: rgba(255,255,255,0.08);
      --divider: rgba(255,255,255,0.10);

      /* ===== Accent ===== */
      --accent: #9FB7A6;               /* sage */
      --accent-2: #D6BE8A;             /* warm gold light */
      --accent-ring: rgba(159,183,166,0.22);

      /* ===== Interactions ===== */
      --hover: rgba(255,255,255,0.06);
      --active: rgba(255,255,255,0.10);
      --focus: rgba(159,183,166,0.22);

      /* ===== Send Button (Primary Action) ===== */
      --send-bg: #ECE6DD;                    /* off-white ấm */
      --send-fg: #141210;                    /* ink tối */
      --send-hover-bg: #F3EDE4;              /* sáng hơn chút */
      --send-active-bg: #E0D8CB;
      --send-disabled-bg: rgba(236,230,221,0.34);
      --send-disabled-fg: rgba(20,18,16,0.55);
      --send-shadow: 0 6px 18px rgba(0,0,0,0.58);

      /* ===== Copy Button (Hover / Active / Copied) ===== */
      --copy-hover-bg: rgba(255,255,255,0.08);
      --copy-active-bg: rgba(255,255,255,0.12);
      --copy-fg: rgba(236,230,221,0.75);
      --copy-fg-active: rgba(236,230,221,0.92);
      --copy-success: #9FB7A6;
      --copy-success-bg: rgba(159,183,166,0.22);

      /* ===== Dropdown Underline (Model Selector / Menu) ===== */
      --dropdown-underline: rgba(214,190,138,0.55);   /* warm gold */
      --dropdown-underline-hover: rgba(214,190,138,0.78);
      --dropdown-underline-active: #D6BE8A;
      --dropdown-item-fg: rgba(236,230,221,0.88);
      --dropdown-item-muted: rgba(236,230,221,0.56);

      /* ===== Selection Highlight (Text Selection) ===== */
      --selection-bg: rgba(214,190,138,0.22);   /* gold wash */
      --selection-fg: #ECE6DD;
      --selection-ui-bg: rgba(159,183,166,0.18);

      /* ===== Focus Ring (Keyboard / Accessibility) ===== */
      --focus-ring: 0 0 0 3px rgba(159,183,166,0.26);

      /* ===== WritingPane Lines ===== */
      --grid: rgba(200, 190, 175, 0.14); /* Grid line - dark mode */
      --grid-strong: rgba(200, 190, 175, 0.18); /* Grid strong - dark mode */
      --margin: rgba(160, 88, 78, 0.22);

      /* ===== Shadows (Paper wins) ===== */
      --shadow-paper: 0 24px 80px rgba(0,0,0,0.62), 0 8px 24px rgba(0,0,0,0.45), 0 2px 8px rgba(0,0,0,0.30);
      --shadow-panel: -10px 0 22px rgba(0,0,0,0.42), -2px 0 8px rgba(0,0,0,0.26);
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.46);
      /* Paper side shadows - dark mode (sáng hơn để tạo contrast trên nền tối) */
      --paper-shadow-side-start: rgba(255,255,255,0);
      --paper-shadow-side-15: rgba(255,255,255,0.01);
      --paper-shadow-side-40: rgba(255,255,255,0.02);
      --paper-shadow-side-65: rgba(255,255,255,0.03);
      --paper-shadow-side-85: rgba(255,255,255,0.04);
      --paper-shadow-side-95: rgba(255,255,255,0.05);
      --paper-shadow-side-end: rgba(255,255,255,0.04);

      /* =========================
         TOPBAR + CLOCK — DARK
         ========================= */

      /* Topbar */
      --topbar-a: #0B0A09;
      --topbar-b: #141210;
      --topbar-fg: var(--text);
      --topbar-border: rgba(255,255,255,0.14);
      --topbar-glass: rgba(255,255,255,0.08);

      /* Clock (NO-PILL) — COLOR SPEC */
      --clock-bg: transparent;
      --clock-border: transparent;
      --clock-fg: rgba(232, 225, 214, 0.62); /* Time text - không trắng tinh, không glow */
      --clock-icon: rgba(232, 225, 214, 0.44); /* Icon */
      --clock-fg-hover: rgba(232, 225, 214, 0.76); /* Hover text */
      --clock-icon-hover: rgba(232, 225, 214, 0.56); /* Hover icon */

      /* Pills */
      --pill-hover: rgba(255,255,255,0.06);
      --pill-active: rgba(255,255,255,0.10);

      /* ===== Chat Panel System (Model Selector / Dropdown / Composer) ===== */
      --chat-bg: var(--panel);
      --chat-border: rgba(255,255,255,0.12);
      --chat-fg: var(--text);
      --chat-muted: var(--muted);

      --model-bg: rgba(255,255,255,0.06);
      --model-bg-hover: rgba(255,255,255,0.10);
      --model-fg-main: var(--text);
      --model-fg-muted: var(--muted);
      --model-border-subtle: rgba(255,255,255,0.12);
      --model-hover: rgba(255,255,255,0.06);
      --model-active: rgba(255,255,255,0.10);
      --model-tick: #ECE6DD;
      --model-accent: #9FB7A6;
      --model-accent-ring: rgba(159,183,166,0.22);

      /* ===== Scrollbar (DARK) ===== */
      --sb-track: rgba(236,230,221,0.06);
      --sb-thumb: rgba(236,230,221,0.22);
      --sb-thumb-hover: rgba(236,230,221,0.32);
    }

    *{ box-sizing:border-box; }

    html, body, #root{
      height:100% !important;
      width:100% !important;
      margin:0 !important;
      padding:0 !important;
      overflow: hidden !important;
    }

    html {
      overflow: hidden !important;
    }

    body{
      background:var(--bg) !important;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      overflow:hidden !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0 !important;
      padding: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }
    
    /* Đảm bảo #root hiển thị và fill viewport */
    #root {
      height: 100vh !important;
      width: 100vw !important;
      display: block !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      position: relative !important;
    }
    
    /* Đảm bảo UI elements hiển thị (backup rule) */
    .app[data-react="true"] { 
      display: flex !important; 
    }
    .topbar[data-react="true"] { 
      display: grid !important; 
    }
    .chat[data-react="true"] {
      display: flex !important;
    }

    /* ===== Topbar layout: clean (no system log) ===== */
    .topbar{
      position:fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--topbar-h, 28px) !important; /* Fallback để tránh layout shift */
      width: 100% !important;
      max-width: 100% !important;
      background: linear-gradient(180deg, var(--topbar-a), var(--topbar-b));
      color: var(--topbar-fg);
      border-bottom: 1px solid var(--topbar-border);
      /* Tránh layout shift khi load */
      contain: layout style;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      margin: 0 !important;
      padding: 0 var(--topbar-pad-x, 10px) !important;
      z-index: 1000;

      display:grid !important;
      grid-template-columns: 1fr 0fr 1fr;
      align-items:center;

      /* System Rail v1.5 - Animation */
      transform: translateY(0);
      transition: transform 140ms ease-out, visibility 140ms ease-out;
      will-change: transform;
      visibility: visible;
    }

    /* Focus mode - ẩn rail hoàn toàn */
    .topbar[data-rail-hidden="true"]{
      transform: translateY(calc(-1 * var(--topbar-h, 28px)));
      visibility: hidden;
      pointer-events: none;
    }

    .tbLeft{ justify-self:start; display:flex; align-items:center; margin-left: calc(-1 * var(--topbar-pad-x, 10px)); } /* Để clockWidget chạm mép trái */
    .tbCenter{ justify-self:center; }
    .tbRight{ justify-self:end; display:flex; align-items:center; gap:10px; }

    .app{
      margin-top: var(--topbar-h, 28px) !important; /* Offset cho topbar fixed */
      height: calc(100vh - var(--topbar-h, 28px)) !important; /* Fallback để tránh layout shift */
      height: calc(100dvh - var(--topbar-h, 28px)) !important;
      width: 100% !important;
      max-width: 100% !important;
      display:flex !important;
      gap: 0 !important; /* Không có gap */
      overflow:hidden !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      margin-bottom: 0 !important;
      padding: 0 !important;
      /* Tránh layout shift khi load */
      contain: layout;
      /* System Rail v1.5 - Khi rail ẩn, app mở rộng */
      transition: margin-top 140ms ease-out, height 140ms ease-out;
    }

    /* Focus mode - app mở rộng lên, không cần margin-top */
    .app[data-rail-hidden="true"]{
      margin-top: 0 !important;
      height: 100vh !important;
      height: 100dvh !important;
    }

    /* Phần giữa - fill khoảng trống */
    .middlePane{
      flex: 1 1 auto; /* Fill khoảng trống còn lại */
      min-width: 0;
      background: var(--desk); /* Middle pane backdrop (desk) */
      overflow: hidden;
    }

    .leftPane{
      width: 200px; /* Width cố định 200px */
      min-width: 200px;
      max-width: 200px;
      flex-shrink: 0; /* Không co lại */
      background:var(--bg-soft);
      display:flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      border-right:1px solid var(--border);
      margin: 0; /* Không có margin */
      padding: 0; /* Padding được handle bởi sidebarMenu */
    }

    .coming{
      max-width:640px;
      width:100%;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      box-shadow: none;
      text-align: center;
    }
    .coming .badge{
      display: none;
    }
    .coming h1{
      display: none;
    }
    .coming p{
      display: none;
    }
    .coming::before{
      content: "Coming soon";
      display: block;
      font-size: 72px;
      font-weight: 300;
      letter-spacing: 0.05em;
      color: var(--muted);
      opacity: 0.25;
      line-height: 1;
      
      /* Glow effect nhẹ */
      text-shadow: 
        0 0 20px rgba(108, 98, 90, 0.15),
        0 0 40px rgba(108, 98, 90, 0.08);
    }

    /* Dark mode: glow mạnh hơn một chút */
    :root[data-theme="dark"] .coming::before{
      text-shadow: 
        0 0 24px rgba(185, 176, 166, 0.20),
        0 0 48px rgba(185, 176, 166, 0.10),
        0 0 72px rgba(185, 176, 166, 0.05);
    }

    .chat{
      width: var(--chat-w, 380px); /* Fallback để tránh layout shift */
      min-width: var(--chat-min-w, 280px);
      max-width: var(--chat-max-w, 560px);
      flex-shrink: 0; /* Không co lại */

      height:100%;
      min-height:0;
      overflow:hidden;
      background:var(--panel);
      /* Tránh layout shift khi load */
      contain: layout style;
      box-shadow: var(--shadow-panel);
      display:flex;
      flex-direction:column;
      position: relative; /* để gắn resizer */
    }

    .wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .scrollArea{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:
        calc(var(--msg-top-inset) + env(safe-area-inset-top, 0px))
        18px
        18px
        18px;
      scroll-behavior:smooth;
      scroll-padding-top:
        calc(var(--msg-top-inset) + env(safe-area-inset-top, 0px));
    }

    .messages{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .turn{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .ai{
      background: transparent;
      border: none;
      box-shadow: none;

      color: var(--aiText);
      font-size:15px;
      line-height:1.65;

      padding: 0;               /* KHÔNG padding */
      margin: 0;                /* spacing do .turn kiểm soát */

      max-width:100%;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .aiPlain{
      color: var(--aiText);
    }

    .aiRender > :first-child,
    .ai > :first-child{
      margin-top:0;
    }

    .aiRender > :last-child,
    .ai > :last-child{
      margin-bottom:0;
    }

    .aiRender > p{
      margin: 0 0 0.8em;
    }

    .userWrap{
      align-self:flex-end;
      display:inline-flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      max-width:85%;
      position:relative;
      margin-top:-3px;
    }
    
    /* Copy button nằm dưới user bubble */
    .userWrap .copyBtn{
      order: 2; /* Đặt copy button xuống dưới */
      margin-top: 2px;
      align-self: flex-end;
    }
    
    .userWrap .user{
      order: 1; /* User bubble ở trên */
    }

    .user{
      background: var(--userBubble);
      color: var(--userText);
      border: 1px solid var(--userBubbleBorder);

      border-radius:18px;
      padding:10px 14px;
      box-shadow: var(--shadow-soft);

      font-size:15px;
      line-height:1.35;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .userText{ display:block; }

    .copyBtn{
      width:22px;
      height:22px;
      border:none;
      border-radius:6px;
      background:transparent;
      color: var(--copy-fg);
      display:grid;
      place-items:center;
      cursor:pointer;
      opacity:0;
      transition: opacity 0.2s ease, background 0.2s ease, color 0.2s ease;
      pointer-events:none;
      position:relative;
    }

    .userWrap:hover .copyBtn,
    .copyBtn:focus-visible{
      opacity:1;
      pointer-events:auto;
    }

    .copyBtn:hover{
      background: var(--copy-hover-bg);
      color: var(--copy-fg-active);
    }

    .copyBtn:active{
      background: var(--copy-active-bg);
    }

    /* Copied state - success */
    .copyBtn[data-copied="true"]{
      color: var(--copy-success);
      background: var(--copy-success-bg);
    }

    .copyBtn:focus-visible{
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .copyBtn::after{
      content: attr(data-tooltip);
      position:absolute;
      right:0;
      bottom:calc(100% + 6px);
      padding:4px 6px;
      border-radius:6px;
      font-size:11px;
      background: var(--panel);
      border: 1px solid rgba(28,26,23,0.10);
      color: rgba(28,26,23,0.92);
      box-shadow:0 6px 14px rgba(15,17,21,0.12);
      white-space:nowrap;
      opacity:0;
      transform: translateY(2px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      pointer-events:none;
    }

    .copyBtn:hover::after,
    .copyBtn:focus-visible::after{
      opacity:1;
      transform: translateY(0);
    }

    .bar{
      padding:14px;
      border-top:1px solid var(--border);
      background:var(--panel);
      flex:0 0 auto;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Model selector container - bên trên chatComposer */
    .modelSelectorContainer{
      display: flex !important;
      align-items: center;
      justify-content: space-between; /* Để snapshot button ở bên phải */
      padding-bottom: 6px; /* Giảm padding */
      min-height: 24px; /* Thu nhỏ */
      visibility: visible !important;
      opacity: 1 !important;
      position: relative; /* Để đặt snapshot button */
    }

    .chatComposer{
      --send-size: 30px;
      --send-icon-size: 20px;

      display:grid;
      grid-template-columns: 1fr var(--send-size);
      align-items:center;
      gap:12px;

      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 28px;
      box-shadow: var(--shadow-soft);

      padding: 8px 10px 8px 18px;
      min-height: 40px;
      max-height: 170px;
      overflow:hidden;
      /* FIX: Lock height để tránh nhảy */
      height: auto;
      contain: layout style; /* Optimize rendering */
    }

    /* ===== Model Selector - Glass Pill (Hướng A) ===== */
    /* Wrapper cho model pill với caret */
    .modelSelectorWrapper{
      position: relative;
      display: inline-flex !important;
      align-items: center;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* Model selector - Glass pill đồng bộ topbar */
    .modelSelector{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;

      height: var(--topbar-pill-h, 20px);
      padding: 0 28px 0 12px;          /* chừa chỗ cho caret */
      border-radius: 8px;               /* Bo tròn nhẹ hơn */

      border: 1px solid var(--model-border-subtle); /* Viền theo VS Code style */
      background: var(--model-bg); /* Đen sâu premium */
      color: var(--model-fg-main); /* Text chính off-white ấm */
      box-shadow: 0 3px 12px rgba(0,0,0,0.35), 0 2px 6px rgba(0,0,0,0.20); /* Hiệu ứng nổi mặc định */

      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.01em;

      cursor: pointer;
      user-select: none;

      outline: none;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", "Inter", "Roboto", system-ui, sans-serif;
      transition: background 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      min-width: 120px;
      line-height: 1;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 10;
    }

    /* Hover: theo VS Code style */
    .modelSelector:hover:not(:disabled) {
      background: var(--model-hover); /* rgba(255,255,255,0.08) */
      box-shadow: 0 4px 16px rgba(0,0,0,0.40), 0 3px 8px rgba(0,0,0,0.25);
      border-color: var(--model-border-subtle);
    }
    
    /* Active: theo VS Code style */
    .modelSelector:active:not(:disabled) {
      background: var(--model-active); /* rgba(255,255,255,0.12) */
    }

    /* Focus: ring mềm với màu accent */
    .modelSelector:focus-visible {
      box-shadow: var(--focus-ring);
    }

    .modelSelector:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Caret (wrap trong container) */
    .modelSelectorWrapper::after{
      content: "▾";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-52%);
      pointer-events: none;
      font-size: 11px;
      opacity: 0.75;
      color: var(--topbar-fg);
    }
    
    /* Ẩn ::after khi dùng custom dropdown */
    .modelSelectorWrapper.hasCustomDropdown::after {
      display: none;
    }

    /* Dark mode - dùng CSS variables tự động, không cần override riêng */

    /* Custom dropdown list styles - VS Code style */
    .modelDropdownList {
      scrollbar-width: thin;
      scrollbar-color: var(--sb-thumb) var(--sb-track);
      background: var(--model-bg); /* Đen sâu premium */
      border: 1px solid var(--model-border-subtle); /* Viền theo VS Code style */
      color: var(--model-fg-main); /* Text chính */
      box-shadow: 0 -4px 16px rgba(0,0,0,0.30), 0 -2px 8px rgba(0,0,0,0.20);
    }

    .modelDropdownList::-webkit-scrollbar {
      width: 8px;
    }

    .modelDropdownList::-webkit-scrollbar-track {
      background: var(--sb-track);
      border-radius: 4px;
    }

    .modelDropdownList::-webkit-scrollbar-thumb {
      background: var(--sb-thumb);
      border-radius: 4px;
    }

    .modelDropdownList::-webkit-scrollbar-thumb:hover {
      background: var(--sb-thumb-hover);
    }

    /* Dark mode cho dropdown list - dùng CSS variables tự động, không cần override riêng */
    /* CSS variables đã tự động thay đổi theo theme */

    .chatComposer:focus-within{
      border-color: var(--border-soft);
      box-shadow: var(--focus-ring), var(--shadow-soft);
    }

    .chatComposerInput{
      width:100%;
      min-width:0;
      border:none;
      outline:none;
      background:transparent;

      font-size:16px;
      font-family:inherit;
      line-height:1.5;
      text-align:left;

      resize:none;
      padding: 0;
      margin:0;
      max-height: 150px;

      overflow-x:hidden;
      overflow-y:auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      
      vertical-align:middle;

      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;

      color: var(--text);
      caret-color: rgba(28,26,23,0.65);
      
      /* FIX: Lock để tránh nhảy */
      box-sizing: border-box;
      transition: none; /* Tắt transition */
      contain: layout style; /* Optimize rendering */
    }

    .chatComposerInput::placeholder{
      color: var(--placeholder, rgba(138,128,119,0.75)); /* Dùng biến CSS và tăng opacity để rõ hơn trong light mode */
    }

    :root[data-theme="dark"] .chatComposer{
      background: #181512; /* sáng hơn panel 1 chút */
    }

    :root[data-theme="dark"] .chatComposerInput{
      color: #f1ebe3;              /* trắng ngà, KHÔNG trắng gắt */
      caret-color: #e6dccf;        /* con trỏ rõ nhưng dịu */
    }

    :root[data-theme="dark"] .chatComposerInput::placeholder{
      color: rgba(241,235,227,0.45);
    }

    .chatSend{
      width:var(--send-size);
      height:var(--send-size);
      border-radius:50%;
      border:none;
      background: var(--send-bg);
      color: var(--send-fg);
      cursor:pointer;
      box-shadow: var(--send-shadow);
      transition: background 0.2s ease, box-shadow 0.2s ease;

      display:grid;
      place-items:center;
      padding:0;
      line-height:0;
    }

    .chatSend:hover:not(:disabled){
      background: var(--send-hover-bg);
    }

    .chatSend:active:not(:disabled){
      background: var(--send-active-bg);
    }

    .chatSend:disabled{
      background: var(--send-disabled-bg);
      color: var(--send-disabled-fg);
      cursor:not-allowed;
      box-shadow: none;
    }

    .chatSend:focus-visible{
      outline: none;
      box-shadow: var(--focus-ring), var(--send-shadow);
    }

    .sendIcon{
      width:var(--send-icon-size);
      height:var(--send-icon-size);
      display:block;
    }


    /* ===== Topbar resizer (drag like Cursor) ===== */
    .topbarResizer{
      position:absolute;
      left:0;
      right:0;
      bottom:-3px;              /* "ăn" xuống app để dễ bắt */
      height:6px;               /* vùng hit */
      cursor: ns-resize;
      touch-action: none;       /* quan trọng cho mobile */
      background: transparent;
    }

    .topbarResizer::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      top:2px;                  /* line nằm giữa vùng hit */
      height:1px;
      background: rgba(255,255,255,0.10);
      opacity:0.0;
      transition: opacity 0.15s ease;
    }

    .topbar:hover .topbarResizer::after{
      opacity:0.9;
    }

    /* khi đang kéo */
    :root[data-resizing="topbar"] .topbarResizer::after{
      opacity:1;
      background: rgba(255,255,255,0.20);
    }

    /* ===== Chat resizer (drag like Cursor) ===== */
    .chatResizer{
      position:absolute;
      left:-8px;        /* "ăn" ra ngoài để dễ bắt hơn */
      top:0;
      bottom:0;
      width:16px;        /* vùng hit rộng hơn để dễ bắt */
      cursor: ew-resize;
      touch-action: none;
      background: transparent;
      z-index: 5;
    }

    .chatResizer::after{
      content:"";
      position:absolute;
      top:0;
      bottom:0;
      left:7px;          /* line nằm giữa vùng hit */
      width:1px;
      background: var(--border-soft);
      opacity:0.0;
      transition: opacity 0.15s ease;
    }

    .chat:hover .chatResizer::after{
      opacity:0.9;
    }

    /* khi đang kéo */
    :root[data-resizing="chat"] .chatResizer::after{
      opacity:1;
      background: var(--accent);
    }

    /* ===== Clock (NO-PILL) ===== */
    .clockWidget{
      height: var(--topbar-h, 28px); /* Chiều cao bằng topbar */
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:0 10px 0 var(--topbar-pad-x, 10px); /* Padding trái bằng padding của topbar để chạm mép */
      border: none;
      background: transparent;
      color: var(--clock-fg);

      font-size: 12px;
      font-weight: 700; /* Typographic micro-rules: 700-800 */
      letter-spacing: 0.01em; /* Rất nhẹ */
      user-select:none;
      transition: color 0.2s ease;
      cursor: default;
    }

    /* Hover state */
    .clockWidget:hover{
      color: var(--clock-fg-hover);
    }

    .clockWidget:hover .clockSvg{
      color: var(--clock-icon-hover);
    }

    .clockSvg{ 
      width:14px; 
      height:14px; 
      color: var(--clock-icon);
      transition: color 0.2s ease;
    }
    
    #clockTime{ 
      font-variant-numeric: tabular-nums; /* Giữ tabular-nums để không "nhảy" bố cục */
    }

    /* kim quay nhẹ */
    .clockHand{
      transform-origin: 12px 12px;
      animation: clockSpin 6s linear infinite;
    }
    @keyframes clockSpin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* ===== Cursor-like theme toggle (centered thumb) ===== */
    .themeToggle{
      /* sizing */
      --toggle-pad: 4px;
      --toggle-w: clamp(64px, calc(var(--topbar-pill-h, 20px) * 3.0), 84px);
      --thumb: calc(var(--topbar-pill-h, 20px) - 8px);
      --seg: calc((var(--toggle-w) - 2 * var(--toggle-pad)) / 2);
      --thumb-offset: calc((var(--seg) - var(--thumb)) / 2);

      position:relative;
      height: var(--topbar-pill-h, 20px);
      width: var(--toggle-w);

      border-radius: 999px;
      border: 1px solid var(--topbar-border);
      background: var(--topbar-glass);
      color: var(--topbar-fg);

      padding: 0 var(--toggle-pad);
      cursor:pointer;
      overflow:hidden;

      /* layout: 2 halves */
      display:grid;
      grid-template-columns: 1fr 1fr;
      align-items:center;
    }

    .themeToggle:hover{
      background: rgba(255,255,255,0.16);
    }

    /* Icon style: Lucide-like */
    .themeIcon{
      width: 16px;
      height: 16px;
      justify-self: center;
      align-self: center;
      z-index: 2;
      pointer-events: none;

      opacity: 0.62;                /* default = inactive */
      transition: opacity 180ms ease, transform 180ms ease;
    }

    .themeIcon.sun{ grid-column: 1; }
    .themeIcon.moon{ grid-column: 2; }

    /* Active icon: LIGHT => sun active */
    :root:not([data-theme="dark"]) .themeIcon.sun{
      opacity: 0.95;
      transform: translateY(-0.2px);
    }
    :root:not([data-theme="dark"]) .themeIcon.moon{
      opacity: 0.50;
    }

    /* Active icon: DARK => moon active */
    :root[data-theme="dark"] .themeIcon.moon{
      opacity: 0.95;
      transform: translateY(-0.2px);
    }
    :root[data-theme="dark"] .themeIcon.sun{
      opacity: 0.50;
    }

    .themeThumb{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);

      width: var(--thumb);
      height: var(--thumb);
      border-radius: 999px;

      left: calc(var(--toggle-pad) + var(--thumb-offset)); /* mặc định = LIGHT */
      transition: left 180ms ease;

      background: rgba(255,255,255,0.65);
      box-shadow: 0 6px 16px rgba(0,0,0,0.16);

      z-index: 1;
      pointer-events:none;
    }

    /* DARK: thumb sang nửa phải, đúng tâm icon moon */
    :root[data-theme="dark"] .themeThumb{
      left: calc(var(--toggle-pad) + var(--seg) + var(--thumb-offset));
      background: rgba(236,230,221,0.22);
      box-shadow: 0 10px 22px rgba(0,0,0,0.42);
    }

    .thinkingText{
      display:inline-block;
      background:linear-gradient(
        90deg,
        #b79f7a 0%,
        #9d8265 42%,
        #a8927a 75%,
        rgba(183,159,122,0.3) 100%
      );
      background-size:220% 100%;
      color:#9d8265;
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
      animation: thinkingShimmer 1.4s ease infinite;
    }

    @keyframes thinkingShimmer{
      0%{ background-position:0 0; }
      100%{ background-position:200% 0; }
    }

    :root[data-theme="dark"] .aiPlain{
      color: #f1ebe3; /* Đảm bảo aiPlain có màu trong dark mode */
    }

    /* Dark mode styles cho Markdown - COMMENTED: sẽ dùng VS Code theme thay thế */
    /* 
    :root[data-theme="dark"] .ai code{
      background: rgba(255,255,255,0.1);
      color: #e6dccf;
    }

    :root[data-theme="dark"] .ai pre{
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }

    :root[data-theme="dark"] .ai pre code{
      background: transparent;
    }
    */

    :root[data-theme="dark"] .ai blockquote{
      border-left-color: rgba(255,255,255,0.3);
      color: rgba(241,235,227,0.8);
    }

    :root[data-theme="dark"] .ai a{
      color: #7cb3f0;
    }

    :root[data-theme="dark"] .ai a:hover{
      color: #9cc5f5;
    }

    :root[data-theme="dark"] .ai table{
      border-color: rgba(255,255,255,0.15);
    }

    :root[data-theme="dark"] .ai th{
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.15);
    }

    :root[data-theme="dark"] .ai td{
      border-color: rgba(255,255,255,0.15);
    }

    :root[data-theme="dark"] .thinkingText{
      /* Gradient động cho dark mode */
      background: linear-gradient(
        90deg,
        rgba(241,235,227,0.50) 0%,
        rgba(241,235,227,0.85) 42%,
        rgba(241,235,227,0.70) 75%,
        rgba(241,235,227,0.30) 100%
      );
      background-size: 220% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: thinkingShimmerDark 1.4s ease infinite;
    }
    
    @keyframes thinkingShimmerDark{
      0%{ background-position:0 0; }
      100%{ background-position:200% 0; }
    }

    /* ===== Scrollbar Rail styling (WebKit) ===== */
    .scrollArea::-webkit-scrollbar{
      width: 10px;
    }

    /* Ẩn scrollbar cho textarea input */
    .chatComposerInput::-webkit-scrollbar{
      display: none;
      width: 0;
      height: 0;
    }

    /* Scroll Rail - gradient dọc để tạo cảm giác rãnh, không phẳng */
    .scrollArea::-webkit-scrollbar-track{
      background: linear-gradient(to bottom,
        var(--rail-wash-top) 0%,
        var(--rail-wash-mid) 50%,
        var(--rail-wash-bot) 100%
      );
      border-radius: 0; /* Bỏ border-radius để rail thẳng */
      border-left: 1px solid var(--rail-edge-soft); /* Edge line nhẹ bên trái - chuyển mềm */
      border-right: 1px solid var(--rail-edge); /* Edge line rõ hơn bên phải */
    }

    .chatComposerInput::-webkit-scrollbar-track{
      display: none;
    }

    .scrollArea::-webkit-scrollbar-thumb{
      background: var(--sb-thumb);
      border-radius: 999px;
      border: 3px solid transparent;       /* tạo "pill" mảnh, tinh tế */
      background-clip: content-box;
    }

    .chatComposerInput::-webkit-scrollbar-thumb{
      display: none;
    }

    .scrollArea::-webkit-scrollbar-thumb:hover{
      background: var(--sb-thumb-hover);
      background-clip: content-box;
    }

    .chatComposerInput::-webkit-scrollbar-thumb:hover{
      display: none;
    }

    /* ===== Scrollbar styling (Firefox) ===== */
    .scrollArea{
      scrollbar-width: thin;
      scrollbar-color: var(--sb-thumb) var(--sb-track);
    }

    /* Ẩn scrollbar cho textarea (Firefox) */
    .chatComposerInput{
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    /* ===== HTML scrollbar ===== */
    html{
      scrollbar-color: var(--sb-thumb) var(--sb-track);
    }
    html::-webkit-scrollbar{ width: 10px; }
    html::-webkit-scrollbar-track{ background: var(--sb-track); }
    html::-webkit-scrollbar-thumb{
      background: var(--sb-thumb);
      border-radius: 999px;
      border: 3px solid transparent;
      background-clip: content-box;
    }
    html::-webkit-scrollbar-thumb:hover{
      background: var(--sb-thumb-hover);
      background-clip: content-box;
    }


    /* ===== Selection Highlight (Text Selection) ===== */
    /* Writing Pane - Paper selection (ink system v2) */
    .writingPane ::selection,
    .writingPane ::-moz-selection{
      /* Background highlight - Giảm opacity để không "đè mực" */
      background: var(--selection-bg-ink, rgba(210, 195, 165, 0.22));
      /* Giữ nguyên ink gradient, không invert màu chữ */
      color: inherit;
    }

    /* Chat / UI Selection (nhẹ hơn paper) */
    .chat ::selection,
    .chat ::-moz-selection,
    .sidebarMenu ::selection,
    .sidebarMenu ::-moz-selection,
    body ::selection,
    body ::-moz-selection{
      background: var(--selection-ui-bg);
      color: var(--text);
    }

    /* ===== Focus Ring (Keyboard / Accessibility) ===== */
    /* Focus ring chỉ xuất hiện khi :focus-visible */
    button:focus-visible,
    input:focus-visible,
    textarea:focus-visible,
    select:focus-visible,
    a:focus-visible{
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .modelSelector:focus-visible {
      box-shadow: var(--focus-ring);
    }

    /* =========================================================
       Code Block SSOT (Light + Dark) - VS Code theme
       ========================================================= */

    /* CRITICAL: Đảm bảo UI chính luôn hiển thị */
    .app[data-react="true"] { 
      display: flex !important; 
    }
    .topbar[data-react="true"] { 
      display: grid !important; 
    }
    .chat[data-react="true"] {
      display: flex !important;
    }

    /* ========== Code Block SSOT (Light + Dark) ========== */
    :root{
      /* Code block - Light mode (VS Code Light+) */
      --code-bg: #ffffff;              /* Nền trắng */
      --code-border: #e5e5e5;          /* Viền xám nhẹ */
      --code-header-bg: #f6f6f6;       /* Header xám nhẹ */
      --code-header-fg: #333;          /* Chữ tối (không phải trắng) */
      --code-copy-bg: transparent;
      --code-copy-fg: #333;            /* Chữ tối (không phải trắng) */
      /* Syntax colors - màu tối để đọc được trên nền sáng */
      --code-text: #1e1e1e;            /* Chữ code base - đen/tối, không phải trắng */
      --code-comment: #6a9955;         /* Comment - xanh lá nhạt */
      --code-keyword: #0000ff;         /* Keyword - xanh dương */
      --code-string: #a31515;          /* String/literal - đỏ */
    }

    :root[data-theme="dark"]{
      /* Code block - Dark mode - ĐEN HẲN, đúng tông */
      --code-bg: #141210;              /* Đen ấm, cùng hệ với panel/chat */
      --code-border: rgba(255,255,255,0.10); /* Viền nhẹ, chỉ để tách khối */
      --code-header-bg: #121110;       /* Header đậm hơn 1 nấc */
      --code-header-fg: #ECE6DD;       /* Chữ off-white ấm */
      --code-copy-bg: transparent;
      --code-copy-fg: #ECE6DD;         /* Chữ off-white ấm */
      /* Syntax colors */
      --code-text: #ECE6DD;            /* Chữ code base - off-white ấm */
      --code-comment: rgba(236,230,221,0.55); /* Comment - dịu xuống nhưng cùng hue */
      --code-keyword: #9FB7A6;         /* Keyword - sage khói, không xanh gắt */
      --code-string: #D4B77C;          /* String/literal - champagne */
    }

    /* Wrapper của code block */
    .codeBlock{
      background: var(--code-bg);
      border: 1px solid var(--code-border);
      border-radius: 8px; /* Bo góc rõ ràng hơn */
      overflow: hidden; /* Đảm bảo bo góc hoạt động đúng */
      box-shadow: none;
    }

    /* Header (PYTHON + Copy) phải cùng "hệ màu" */
    .codeBlockHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      background: var(--code-header-bg);
      color: var(--code-header-fg);
      border-bottom: 1px solid var(--code-border);
      border-radius: 8px 8px 0 0; /* Bo góc trên để khớp với wrapper */
      position: relative;
      z-index: 10;
      min-height: 48px; /* Height cố định để tránh giãn */
      box-sizing: border-box; /* Đảm bảo padding tính trong height */
    }

    .codeLangTag{
      font-size: 12px;
      font-weight: 700;
      opacity: 0.9;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(127,127,127,0.12);
    }

    .codeCopyBtn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      font-weight: 700;
      border: 0;
      background: var(--code-copy-bg);
      color: var(--code-copy-fg);
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 8px;
      position: relative;
      z-index: 11;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      min-width: 60px; /* Width cố định để tránh nhảy khi text thay đổi */
      height: 28px; /* Height cố định để tránh code block bị giãn */
      line-height: 1; /* Line height cố định */
      justify-content: center; /* Căn giữa text */
      box-sizing: border-box; /* Đảm bảo padding tính trong height */
    }
    .codeCopyBtn:hover{
      background: rgba(127,127,127,0.12);
    }
    .codeCopyBtn:active{
      transform: scale(0.98);
    }

    /* Ép pre/code đồng nhất nền (quan trọng) */
    .codeBlock pre{
      margin: 0 !important;
      background: var(--code-bg) !important;
      border: 0 !important;
      border-radius: 0 0 8px 8px !important; /* Bo góc dưới để khớp với wrapper */
      box-shadow: none !important;
      overflow: visible !important;
      max-height: none !important;
      height: auto !important;
    }

    .codeBlock pre code{
      background: transparent !important;
      color: var(--code-text) !important; /* Chữ code base - tối cho light, sáng cho dark */
    }
    
    /* Đảm bảo text trong code block light mode không phải màu trắng */
    :root:not([data-theme="dark"]) .codeBlock pre code {
      color: var(--code-text, #1e1e1e) !important; /* Màu tối, không phải trắng */
    }
    
    /* Text trong code block dark mode */
    :root[data-theme="dark"] .codeBlock pre code {
      color: var(--code-text, #ECE6DD) !important; /* Màu sáng cho dark mode */
    }

    /* Override syntax highlighting colors cho light mode - màu tối, không phải trắng */
    :root:not([data-theme="dark"]) .codeBlock pre code .token.comment,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.prolog,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.doctype,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.cdata {
      color: var(--code-comment, #6a9955) !important; /* Xanh lá nhạt - màu tối */
    }

    :root:not([data-theme="dark"]) .codeBlock pre code .token.keyword,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.selector,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.attr-name,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.property,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.class-name,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.function {
      color: var(--code-keyword, #0000ff) !important; /* Xanh dương - màu tối */
    }

    :root:not([data-theme="dark"]) .codeBlock pre code .token.string,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.char,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.attr-value,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.regex,
    :root:not([data-theme="dark"]) .codeBlock pre code .token.variable {
      color: var(--code-string, #a31515) !important; /* Đỏ - màu tối */
    }

    /* Override syntax highlighting colors cho dark mode */
    :root[data-theme="dark"] .codeBlock pre code .token.comment,
    :root[data-theme="dark"] .codeBlock pre code .token.prolog,
    :root[data-theme="dark"] .codeBlock pre code .token.doctype,
    :root[data-theme="dark"] .codeBlock pre code .token.cdata {
      color: var(--code-comment, rgba(236,230,221,0.55)) !important;
    }

    :root[data-theme="dark"] .codeBlock pre code .token.keyword,
    :root[data-theme="dark"] .codeBlock pre code .token.selector,
    :root[data-theme="dark"] .codeBlock pre code .token.attr-name,
    :root[data-theme="dark"] .codeBlock pre code .token.property,
    :root[data-theme="dark"] .codeBlock pre code .token.class-name,
    :root[data-theme="dark"] .codeBlock pre code .token.function {
      color: var(--code-keyword, #9FB7A6) !important; /* Sage khói */
    }

    :root[data-theme="dark"] .codeBlock pre code .token.string,
    :root[data-theme="dark"] .codeBlock pre code .token.char,
    :root[data-theme="dark"] .codeBlock pre code .token.attr-value,
    :root[data-theme="dark"] .codeBlock pre code .token.regex,
    :root[data-theme="dark"] .codeBlock pre code .token.variable {
      color: var(--code-string, #D4B77C) !important; /* Champagne */
    }

    /* Inline code (không phải block) */
    .ai :not(pre) > code{
      background: rgba(127,127,127,0.14) !important;
      border: 1px solid rgba(127,127,127,0.18);
      border-radius: 6px;
      padding: 0.15em 0.35em;
    }

    /* Bỏ scroll hoàn toàn - code hiển thị đầy đủ */
    .codeBlock pre {
      overflow: visible !important;
      max-height: none !important;
      height: auto !important;
    }
    .codeBlock pre::-webkit-scrollbar { 
      display: none;
    }

    /* ===== Sidebar Menu ===== */
    .sidebarMenu {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 16px;
      box-sizing: border-box; /* Padding tính trong width */
      position: relative;
    }

    /* List section (phần trên) */
    .sidebarListSection {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      min-height: 0;
    }

    /* Separator line */
    .sidebarSeparator {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
      flex-shrink: 0;
    }

    /* User profile section (phần dưới) - y hệt như hình, gần đáy */
    .sidebarUserProfile {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px 0;
      flex-shrink: 0;
      background: transparent;
      margin-top: auto; /* Đẩy xuống gần đáy */
    }

    .sidebarUserInfoRow {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebarUserAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      background: rgba(255,255,255,0.1); /* Nền xám đậm hơn một chút */
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .sidebarAvatarImg {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .sidebarAvatarPlaceholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #fff; /* Chữ trắng */
      background: transparent;
    }

    .sidebarUserText {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }

    .sidebarUserName {
      font-size: 14px;
      font-weight: 600;
      color: var(--text); /* Màu trắng */
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebarUserSubInfo {
      font-size: 12px;
      font-weight: 400;
      color: var(--muted); /* Màu xám nhẹ hơn */
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* User actions (đăng xuất) */
    .sidebarUserActions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebarSignOutBtn {
      width: 100%;
      padding: 8px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
      font-family: inherit;
    }

    .sidebarSignOutBtn:hover {
      background: var(--hover, rgba(255,255,255,0.08));
      border-color: var(--border-soft);
    }

    /* Auth switch link */
    .sidebarAuthSwitch {
      margin-top: 12px;
    }

    .sidebarAuthSwitch a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }

    .sidebarAuthSwitch a:hover {
      text-decoration: underline;
    }

    /* Auth section khi chưa đăng nhập */
    .sidebarAuthSection {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ===== Auth Modal (cửa sổ đăng nhập ở giữa màn hình) ===== */
    .authModalOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }

    /* Overlay background - phù hợp với theme */
    :root .authModalOverlay {
      background: rgba(28, 26, 23, 0.4); /* Light mode: warm charcoal mờ */
    }

    :root[data-theme="dark"] .authModalOverlay {
      background: rgba(0, 0, 0, 0.6); /* Dark mode: đen mờ hơn */
    }

    .authModalContainer {
      width: 400px;
      min-height: 300px;
      max-height: 90vh;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      padding: 0;
      box-sizing: border-box;
    }

    /* Box shadow - phù hợp với theme */
    :root .authModalContainer {
      box-shadow: 
        0 4px 16px rgba(28, 26, 23, 0.12),
        0 8px 32px rgba(28, 26, 23, 0.08);
    }

    :root[data-theme="dark"] .authModalContainer {
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.4),
        0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .authModalSwitch {
      padding: 0 20px 20px 20px;
    }

    .authModalSwitch a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      transition: opacity 0.2s ease;
    }

    .authModalSwitch a:hover {
      text-decoration: underline;
      opacity: 0.8;
    }

    /* Clerk components styling trong modal - phù hợp với theme */
    .authModalContainer .cl-rootBox {
      width: 100% !important;
      max-width: 100% !important;
    }

    .authModalContainer .cl-card {
      width: 100% !important;
      max-width: 100% !important;
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      border-radius: 8px !important;
      padding: 20px !important;
      box-shadow: none !important;
    }

    .authModalContainer .cl-headerTitle {
      font-size: 18px !important;
      font-weight: 700 !important;
      color: var(--text) !important;
    }

    .authModalContainer .cl-headerSubtitle {
      font-size: 13px !important;
      color: var(--muted) !important;
    }

    .authModalContainer .cl-socialButtonsBlockButton {
      background: var(--bg-soft) !important;
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
      color: var(--text) !important;
      font-weight: 600 !important;
      transition: background 0.2s ease, border-color 0.2s ease !important;
    }

    .authModalContainer .cl-socialButtonsBlockButton:hover {
      background: var(--panel-soft) !important;
      border-color: var(--border-soft) !important;
    }

    .authModalContainer .cl-formButtonPrimary {
      background: var(--accent) !important;
      color: var(--text) !important;
      border-radius: 6px !important;
      font-weight: 600 !important;
      transition: opacity 0.2s ease !important;
    }

    .authModalContainer .cl-formButtonPrimary:hover {
      opacity: 0.9 !important;
    }

    .authModalContainer .cl-formFieldInput {
      background: var(--bg-soft) !important;
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
      color: var(--text) !important;
    }

    .authModalContainer .cl-formFieldInput:focus {
      border-color: var(--accent) !important;
      outline: none !important;
    }

    .authModalContainer .cl-footerActionLink {
      color: var(--accent) !important;
    }

    .authModalContainer .cl-footerActionLink:hover {
      opacity: 0.8 !important;
    }

    /* Responsive cho modal */
    @media (max-width: 480px) {
      .authModalContainer {
        width: calc(100vw - 32px);
        max-width: 400px;
      }
    }

    .sidebarAuthHeader {
      text-align: center;
      margin-bottom: 8px;
    }

    .sidebarAuthTitle {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 8px 0;
    }

    .sidebarAuthSubtitle {
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    .sidebarAuthForms {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebarSignIn {
      width: 100%;
    }

    /* Clerk components styling - override để fit sidebar */
    .sidebarAuthForms [data-clerk-element] {
      width: 100% !important;
      max-width: 100% !important;
    }

    .sidebarAuthForms .cl-rootBox {
      width: 100% !important;
      max-width: 100% !important;
    }

    .sidebarAuthForms .cl-card {
      width: 100% !important;
      max-width: 100% !important;
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      border-radius: 8px !important;
      padding: 16px !important;
      box-shadow: none !important;
    }

    .sidebarAuthForms .cl-headerTitle {
      font-size: 16px !important;
      font-weight: 700 !important;
      color: var(--text) !important;
    }

    .sidebarAuthForms .cl-headerSubtitle {
      font-size: 12px !important;
      color: var(--muted) !important;
    }

    .sidebarAuthForms .cl-formButtonPrimary {
      background: var(--accent) !important;
      color: var(--text) !important;
      border-radius: 6px !important;
      font-weight: 600 !important;
      transition: background 0.2s ease !important;
    }

    .sidebarAuthForms .cl-formButtonPrimary:hover {
      opacity: 0.9 !important;
    }

    .sidebarAuthForms .cl-formFieldInput {
      background: var(--bg-soft) !important;
      border: 1px solid var(--border) !important;
      border-radius: 6px !important;
      color: var(--text) !important;
    }

    .sidebarAuthForms .cl-footerActionLink {
      color: var(--accent) !important;
    }

    /* Scrollbar cho sidebar */
    .leftPane::-webkit-scrollbar {
      width: 6px;
    }

    .leftPane::-webkit-scrollbar-track {
      background: transparent;
    }

    .leftPane::-webkit-scrollbar-thumb {
      background: var(--sb-thumb);
      border-radius: 3px;
    }

    .leftPane::-webkit-scrollbar-thumb:hover {
      background: var(--sb-thumb-hover);
    }

    .leftPane {
      scrollbar-width: thin;
      scrollbar-color: var(--sb-thumb) transparent;
    }
  </style>
</head>

<body>
  <!-- React sẽ render toàn bộ UI vào #root -->
  <div id="root"></div>
  <script type="module" src="/src/main-clerk.jsx"></script>
</body>
</html>
